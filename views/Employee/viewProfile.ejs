<!DOCTYPE html>
<html>
<%- include('../partials/header') %>
<link rel="stylesheet" href="/stylesheets/thuongTitle.css" />
<link rel="stylesheet" href="/stylesheets/thuongTitle.css" />
    <body>
         <nav class="navbar navbar-default no-margin">
            <!-- Brand and toggle get grouped for better mobile display -->

            <div class="navbar-header fixed-brand">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" id="menu-toggle">
                    <span class="glyphicon glyphicon-th-large" style="margin-left: 5px" aria-hidden="true"></span>
                </button>
                <a class="navbar-brand" href="#">
                    <%= userName %>
                </a>
            </div>
            <!-- navbar-header-->

            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <button class="navbar-toggle collapse in" data-toggle="collapse" id="menu-toggle-2">
                            <span class="glyphicon glyphicon-th-large" aria-hidden="true"></span>
                        </button>
                    </li>
                    <li class="navbar-brand">
                        <form action="/logout" method="get">
                            <button id="logout" type="submit" style="margin-top: -3px" class="btn btn-default">
                                <i class="fa fa-sign-out" aria-hidden="true"></i> Logout
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
            <!-- bs-example-navbar-collapse-1 -->
        </nav>
        <div id="wrapper">
            <!-- Include the common employee sidebar -->
            <%- include('../partials/employee_sidebar') %>
            
            <!-- Page Content -->
            <div id="page-content-wrapper">
                <div class="container-fluid xyz">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="page-header">
                                <h2 class="ThuongTitleMyProfileEmployee"><i class="fa fa-angle-right"></i> My Profile</h2>
                                <style>
                                    .ThuongTitleMyProfileEmployee {
                                        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                                        font-size: 1.6em;
                                        padding-bottom: 9px;
                                        margin: -30px 0 20px;
                                        border-bottom: 1px solid #eee;
                                        font-weight: bold;
                                        color: #333;
                                      }
                                      </style>
                           

                            <div class="profile-container">
                                <div class="row">
                                    <!-- Left side profile card -->
                                    <div class="col-md-4">
                                        <div class="profile-card">
                                            <div class="profile-header" style="background-color: #222;">
                                                <div class="employment-badge">
                                                    <% if (employee.employeeType) { %>
                                                        <%= employee.employeeType %>
                                                    <% } else if (employee.employmentType) { %>
                                                        <%= employee.employmentType === 'full-time' ? 'Full-Time' : 'Part-Time' %>
                                                    <% } else { %>
                                                        Full-time
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="profile-body text-center">
                                                <div class="profile-image">
                                                    <% if(employee.photo) { %>
                                                        <img src="/uploads/<%= employee.photo %>" alt="<%= employee.name %>" class="img-circle">
                                                    <% } else { %>
                                                        <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Default Avatar" class="img-circle">
                                                    <% } %>
                                                </div>
                                                <h3 class="profile-name"><%= employee.name %></h3>
                                                <p class="profile-id">@<%= employee.jobId || (employee._id.toString().substr(-2)) %></p>
                                                
                                                <hr>
                                                
                                                <div class="profile-details">
                                                    <p>
                                                        <i class="fa fa-briefcase"></i> 
                                                        <%= employee.designation || "UI Designer" %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-building"></i> 
                                                        Working at: <%= employee.department || 'IT Department' %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-envelope"></i> 
                                                        <%= employee.personalEmail || employee.email %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-phone"></i> 
                                                        +84<%= employee.contactNumber || "933387264" %>
                                                    </p>
                                                    <% if (employee.supervisor) { %>
                                                    <p>
                                                        <i class="fa fa-user"></i> 
                                                        Report by: <%= employee.supervisor %>
                                                    </p>
                                                    <% } %>
                                                    <p>
                                                        <i class="fa fa-calendar"></i> 
                                                        Birthday on: <%= moment(employee.dateOfBirth).format('DD MMMM') %>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right side information panels -->
                                    <div class="col-md-8">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="info-box">
                                                    <div class="info-box-icon">
                                                        <i class="fa fa-calendar-check-o"></i>
                                                    </div>
                                                    <div class="info-box-content">
                                                        <h4>Start Date</h4>
                                                        <p><%= employee.startDate ? moment(employee.startDate).format('DD MMMM YYYY') : '20 April 2021' %></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="info-box">
                                                    <div class="info-box-icon">
                                                        <i class="fa fa-birthday-cake"></i>
                                                    </div>
                                                    <div class="info-box-content">
                                                        <h4>Date of Birth</h4>
                                                        <p><%= moment(employee.dateOfBirth).format('DD MMMM YYYY') %></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Personal Information Panel -->
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Personal information</h3>
                                                <button type="button" class="btn btn-default btn-xs btn-edit" data-toggle="modal" data-target="#editProfileModal">
                                                    <i class="fa fa-pencil"></i> Edit
                                                </button>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Name:</strong></div>
                                                    <div class="col-md-9"><%= employee.name %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Gender:</strong></div>
                                                    <div class="col-md-9">
                                                        <%= employee.gender ? (employee.gender.charAt(0).toUpperCase() + employee.gender.slice(1)) : 'Female' %>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Birthname:</strong></div>
                                                    <div class="col-md-9"><%= employee.birthName %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Birthplace:</strong></div>
                                                    <div class="col-md-9"><%= employee.birthplace || 'Hanoi' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Address:</strong></div>
                                                    <div class="col-md-9">
                                                        <% if (employee.detailedAddress || employee.district || employee.province) { %>
                                                            <%= [employee.detailedAddress, employee.district, employee.province].filter(Boolean).join(', ') %>
                                                        <% } else { %>
                                                            Nguyen Trai St, Trung Van Ward, Nam Tu Liem District, Hanoi
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>ID Number:</strong></div>
                                                    <div class="col-md-9"><%= employee.idNumber || '035304001786' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Personal Email:</strong></div>
                                                    <div class="col-md-9"><%= employee.personalEmail || (employee.email.replace('@hrms.com', '@gmail.com')) %></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Job Information Panel -->
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Job information</h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Job ID:</strong></div>
                                                    <div class="col-md-9"><%= employee.jobId || 'Not assigned' %></div>
                                                </div>
                                               
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Job Title:</strong></div>
                                                    <div class="col-md-9"><%= employee.designation || 'Admin' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Official Email:</strong></div>
                                                    <div class="col-md-9"><%= employee.officeEmail || employee.officeEmail %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Employment Type:</strong></div>
                                                    <div class="col-md-9">
                                                        <% if (employee.employeeType) { %>
                                                            <%= employee.employeeType %>
                                                        <% } else if (employee.employmentType) { %>
                                                            <%= employee.employmentType === 'full-time' ? 'Full-Time' : 'Part-Time' %>
                                                        <% } else { %>
                                                            Full-Time
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <% if (employee.supervisor) { %>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Supervisor:</strong></div>
                                                    <div class="col-md-9"><%= employee.supervisor %></div>
                                                </div>
                                                <% } %>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Department:</strong></div>
                                                    <div class="col-md-9"><%= employee.department || 'HR & Administration' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Work Experience:</strong></div>
                                                    <div class="col-md-9"><%= employee.experience || 'Senior' %></div>
                                                </div>
                                                <% if (employee.Skills && employee.Skills.length > 0) { %>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Skills:</strong></div>
                                                    <div class="col-md-9">
                                                        <% employee.Skills.forEach(function(skill, index) { %>
                                                            <% if (skill !== "") { %>
                                                                <span class="badge badge-info"><%= skill %></span>
                                                            <% } %>
                                                        <% }); %>
                                                    </div>
                                                </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /#page-content-wrapper -->
        </div>
        <!-- /#wrapper -->
        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.js" charset="UTF-8"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js" charset="UTF-8"></script>
        <script src="/javascripts/sidebar_menu.js"></script>
        
        <!-- CSS for profile page -->
        <style>
            /* Styles for profile page */
            .profile-container {
                margin-top: 20px;
            }
            .profile-card {
                border: 1px solid #ddd;
                border-radius: 5px;
                overflow: hidden;
                margin-bottom: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .profile-header {
                height: 50px;
                position: relative;
            }
         
            .employment-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(255,255,255,0.8);
                color: #333;
                padding: 5px 10px;
                border-radius: 3px;
                font-size: 12px;
                font-weight: bold;
            }
            .profile-body {
                padding: 20px;
                background-color: #f9f9f9;
            }
            .profile-image {
                position: relative;
                z-index: 2;
                text-align: center;
                margin-bottom: 15px;
            }
            .profile-image img {
                width: 120px;
                height: 120px;
                border: 5px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                margin-top: -60px;
                display: inline-block;
            }
            .profile-name {
                font-size: 24px;
                margin-bottom: 5px;
            }
            .profile-id {
                color: #666;
                margin-bottom: 15px;
            }
            .profile-details {
                text-align: left;
            }
            .profile-details p {
                margin-bottom: 10px;
            }
            .profile-details i {
                margin-right: 10px;
                width: 16px;
                color: #3498db;
            }
            .info-box {
                display: flex;
                background-color: #e8f4fc;
                border-radius: 5px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .info-box-icon {
                font-size: 24px;
                margin-right: 15px;
                color: #3498db;
            }
            .info-box-content h4 {
                margin-top: 0;
                margin-bottom: 5px;
                font-size: 16px;
                color: #555;
            }
            .info-box-content p {
                margin: 0;
                font-size: 16px;
                font-weight: bold;
            }
            .panel-info > .panel-heading {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: #d9edf7;
                color: #31708f;
            }
            .panel-title {
                margin: 0;
            }
            .btn-edit {
                padding: 2px 8px;
            }
            .row.mb-3 {
                margin-bottom: 15px;
            }
            .badge-info {
                background-color: #3498db;
                margin-right: 5px;
                padding: 5px 10px;
                border-radius: 3px;
                color: white;
                display: inline-block;
            }
            .page-header {
                margin-bottom: 20px;
            }
            .breadcrumb {
                background-color: #f8f8f8;
                padding: 8px 15px;
                margin-bottom: 10px;
                border-radius: 4px;
            }
        </style>
    </body>
    <script>
        $(document).ready(function () {
           // Any additional script can go here

           var originalValues = {
               birthName: '',
               personalEmail: '',
               contactNumber: '',
               photoFileName: ''
           };

           var $saveButton = $('#editProfileModal').find('button.btn-primary.btn-custom[type="submit"]');

           // Disable Save button initially when modal opens
           $('#editProfileModal').on('show.bs.modal', function () {
               // Store original values
               originalValues.birthName = $('#editbirthName').val() || '';
               originalValues.personalEmail = $('#editEmail').val() || '';
               originalValues.contactNumber = $('#editContactNumber').val() || '';
               originalValues.photoFileName = $('#file-name-display').text().trim() || '';

               // Disable Save button initially
               $saveButton.prop('disabled', true);
           });

           // Function to check if any field has changed
           function checkForChanges() {
               var currentBirthName = $('#editbirthName').val() || '';
               var currentPersonalEmail = $('#editEmail').val() || '';
               var currentContactNumber = $('#editContactNumber').val() || '';
               var currentPhotoFileName = $('#file-name-display').text().trim() || '';

               if (
                   currentBirthName !== originalValues.birthName ||
                   currentPersonalEmail !== originalValues.personalEmail ||
                   currentContactNumber !== originalValues.contactNumber ||
                   currentPhotoFileName !== originalValues.photoFileName
               ) {
                   $saveButton.prop('disabled', false);
               } else {
                   $saveButton.prop('disabled', true);
               }
           }

           // Attach event listeners to inputs
           $('#editbirthName, #editEmail, #editContactNumber').on('input', function () {
               checkForChanges();
           });

           // Listen for photo file input change
           $('#photo').on('change', function () {
               // The file name display is updated by existing code, so just check changes
               checkForChanges();
           });
        });
    </script>
    <div id="myModal2" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <form method="post" action="/employee/mark-employee-attendance">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            &times;
                        </button>
                        <h4 class="modal-title">Mark Attendance</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to mark attendance.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="reset" class="btn btn-default" data-dismiss="modal">
                            No
                        </button>
                        <button type="submit" class="btn btn-default">Yes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <form method="post" action="/employee/view-attendance">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            &times;
                        </button>
                        <h4 class="modal-title">Select Month/Year</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="Month">Month:</label>
                            <select class="form-control" id="month" name="month">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="year">Year:</label>
                            <select class="form-control" id="year" name="year"></select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="reset" class="btn btn-default" data-dismiss="modal">
                            Close
                        </button>
                        <button type="submit" class="btn btn-default">View</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
 <!-- Edit Profile Modal -->
 <div id="editProfileModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="menu1" style="height:717px; overflow: auto;">
                <form id="employee-form" class="form-horizontal" action="/employee/update-profile-bypass/<%= employee._id %>" method="post" enctype="multipart/form-data">
                    <div class="panel panel-default444">
                        <div class="profile-panel">
    <div class="profile-header">
        <h4 class="profile-title">My Profile</h4>
        <div class="profile-buttons">
            <button type="button" onclick="window.location.href='/employee/view-profile'" class="btn btn-default btn-custom">Cancel</button>
            <button type="submit" class="btn btn-primary btn-custom">Save</button>
        </div>
    </div>
</div>

<style>
/* Tổng thể panel */
.profile-panel {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    max-width: 900px;
    margin: 0 auto;
    color:#333;
}


/* Tiêu đề bên trái */
.profile-title {
    font-size: 20px;
    font-weight: bold;
    margin: 0;
}

/* Nhóm nút bên phải */
.profile-buttons {
    display: flex;
    gap: 12px;
}

/* Tùy chỉnh nút */
.btn-custom {
    min-width: 75px;
    height: 38px;
    font-size: 14px;
    border-radius: 6px;
    padding: 8px 20px;
    white-space: nowrap;
    border-color: #c5bebe;
}
.profile-header {
                height: 50px;
                position: relative;
             
            }
            /* Header chứa title và button - dùng flex chia trái/phải */
.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap; /* Không cho xuống dòng */
}
     
.profile-header {
              
              height: 50px;
              position: relative;
          }
</style>
                   <!-- Personal Information Section -->
                   <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">Personal Information</h4>
                    </div>
                    <div class="panel-body">
                        <!-- Form Legend - Required Fields -->
                        <div class="form-legend">
                            <span class="text-danger">* Indicates required field</span>
                        </div>
                    
                        <!-- Name Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Name: <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                             
                                <input type="text" class="form-control" id="editName" name="name" value="<%= employee.name %>" required disabled maxlength="50" pattern="^[A-Za-zÀ-ỹ\s\-]+$" title="Alphabetical + Vietnamese chars only. No numbers or symbols except hyphens.">
                                <span class="help-block error-message" style="display:none; color:#a94442;">First name is required!</span>
                            </div>
                           
                        </div>
                        
                        <!-- Birth Name Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Birth Name:</label>
                            <div class="col-sm-10">
                               
                                <input type="text" class="form-control"  id="editbirthName" name="birthName" placeholder="Birthname" maxlength="100" pattern="^[A-Za-zÀ-ỹ\s\-]+$" title="Alphabetical + Vietnamese chars only. No numbers or symbols except hyphens.">
                            </div>
                        </div>
                        
                        <!-- Date of Birth Field -->
                <div class="form-group">
                            <label class="col-sm-2 control-label">Date of Birth: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control" id="editDateOfBirth" name="dateOfBirth" value="<%= moment(employee.dateOfBirth).format('YYYY-MM-DD') %>"disabled>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Date of birth is required!</span>
                            </div>
                            <label class="col-sm-2 control-label">Gender: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="male" checked disabled> Male
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="female" disabled> Female
                                </label>
                            </div>
                </div>
                        
                        <!-- Personal Email Field -->
                <div class="form-group">
                            <label class="col-sm-2 control-label">Personal Email: <span class="text-danger">*</span></label>
                            <div class="col-sm-10">
                               
                                <input type="text" class="form-control" id="editEmail" name="editPersonalEmail" placeholder="Example: thwlez041207@gmail.com">
                                <span class="help-block error-message" style="display:none; color:#a94442;">Email address is required and must be a valid Gmail address!</span>
                    <% if(hasErrors){ %>
                    <% messages.forEach(function(item){
                                        if(item === "Email is already in use"){ %>
                                            <span class="help-block text-danger"><%= item %></span>
                    <% }
                    }) %>
                    <% } %>
                </div>
                        </div>
                        
                        <!-- Phone Number Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Phone Number: <span class="text-danger">*</span></label>
                            <div class="col-sm-5">
                                <div class="input-group">
                                    <span class="input-group-addon">+84</span>
                                    
                                    <input type="text" class="form-control" id="editContactNumber" name="contactNumber" placeholder="Phone number" maxlength="9" pattern="^[1-9]\d{8}$" title="Enter 9 digits starting with a digit from 1-9">
                                </div>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Enter a valid Vietnamese phone number (9 digits starting with a digit from 1-9)</span>
                            </div>
                        </div>
                        <!-- Address Fields -->
                <!-- Address Fields -->
                <div class="form-group">
                  <label class="col-sm-2 control-label">Address: <span class="text-danger">*</span></label>
                  <div class="col-sm-3">
                    <input type="province" class="form-control" id="editProvince" name="district" value="<%= employee.district %>" required disabled>
                      <span class="help-block error-message" style="display:none; color:#a94442;">Province is required!</span>
                  </div>
                  <div class="col-sm-3">
                    <input type="district" class="form-control" id="editDistrict" name="district" value="<%= employee.district %>" required disabled>
                           
                      <span class="help-block error-message" style="display:none; color:#a94442;">District is required!</span>
                  </div>
                  <div class="col-sm-4">
                    <input class="form-control" id="editDetailedAddress" name="detailedAddress" rows="2" placeholder="Street address" disabled>
                      <span class="help-block error-message" style="display:none; color:#a94442;">Detailed address is required!</span>
                  </div>
              </div>
                        
                        <!-- Birthplace Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Birthplace: <span class="text-danger">*</span></label>
                            <div class="col-sm-5">
                                <input type="text" class="form-control" id="editBirthplace" name="birthplace" placeholder="City/Province"disabled>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Birthplace is required!</span>
                            </div>
                </div>
                        
                        <!-- ID Number Field -->
                <div class="form-group">
                            <label class="col-sm-2 control-label">ID Number (CCCD): <span class="text-danger">*</span></label>
                            <div class="col-sm-5">
                              
                                <input type="text" class="form-control" id="editIdNumber" name="idNumber" placeholder="National ID"disabled required maxlength="12" pattern="^\d{12}$" title="Must be exactly 12 digits">
                                <span class="help-block error-message" style="display:none; color:#a94442;">ID number is required!</span>
                            </div>
                        </div>
                        
                        <!-- Photo Upload Field -->
                        <div class="form-group">
                          <label class="col-sm-2 control-label">Photo:</label>
                          <div class="col-sm-10">
                              <div class="row">
                                <div class="col-sm-4">
                                    <div class="thumbnail" style="width: 150px; height: 150px; margin-bottom: 10px;">
                                      <% if(employee.photo) { %>
                                          <img src="/uploads/<%= employee.photo %>" alt="<%= employee.name %>" class="img-circle">
                                      <% } else { %>
                                          <img src="https://bootdey.com/img/Content/avatar/avatar7.png"  alt="Upload Photo" style="max-width: 100%; max-height: 100%;" class="img-circle">
                                      <% } %>

                                      
                                    </div>
                                </div>
                                  <div class="col-sm-8">
                                      <div class="custom-file-upload">
                            
                                          <input type="file" id="photo" name="photo" accept="image/*" style="position: absolute; left: -9999px;">
                                          <button type="button" class="btn btn-primary" onclick="document.getElementById('photo').click();">
                                              <i class="fa fa-upload"></i> Upload Photo
                                          </button>
                                          <span id="file-name-display" style="margin-left: 10px;">
                                              <%= employee.photo ? 'Current photo' : 'No file chosen' %>
                                          </span>
                                      </div>
                                      <p class="help-block">Upload a profile photo (optional)</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                        <!-- Password Field (Hidden but required) -->
                        <div class="form-group" style="display: none;">
                            <label class="col-sm-2 control-label">Password:</label>
                            <div class="col-sm-4">
                                <input type="password" class="form-control" name="password" value="123456" minlength="6">
                                <span class="help-block">Default password will be set and can be changed later</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Job Information Section -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">Job Information</h4>
                </div>
                    <div class="panel-body">
                        <!-- Job Title Field -->
                <div class="form-group">
                            <label class="col-sm-2 control-label">Job Title: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="editDesignation" name="Designation" disabled>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Job title is required!</span>
                            </div>
                            <label class="col-sm-2 control-label">Department: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <input type="department" class="form-control" id="editDepartment" name="department"disabled>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Department is required!</span>
                            </div>
                        </div>
                        
                        <!-- Job ID Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Job ID:</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="editJobId" name="jobId" placeholder="Example: ADM001"disabled>
                 
                            </div>
                </div>
                        
                        <!-- Office Email Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Office Email: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <div class="input-group">
                                   
                                    <input type="officeEmail" class="form-control" id="editPersonalEmail" name="officeEmail" value="<%= employee.officeEmail %>" required disabled pattern="[a-z0-9._%+\-]+@([a-z0-9\-]+\.)+[a-z]{2,}$" title="Please enter a valid company email address">
                                    <span class="input-group-addon"><i class="fa fa-envelope"></i></span>
                                </div>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Office email is required and must be a valid company email!</span>
                                <% if(hasErrors){ %>
                                <% messages.forEach(function(item){
                                    if(item === "Office Email is already in use"){ %>
                                        <span class="help-block text-danger"><%= item %></span>
                                <% }
                                }) %>
                                <% } %>
                            </div>
                </div>
                        
                        <!-- Supervisor Field -->
                <div class="form-group">
                            <label class="col-sm-2 control-label">Supervisor:</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="editSupervisor" name="Supervisor"disabled>
                                
                            </div>
                        </div>
                        
                        <!-- Employee Type Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Employee Type: <span class="text-danger">*</span></label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="editEmployeeType" name="EmployeeType"disabled>
                                <span class="help-block error-message" style="display:none; color:#a94442;">Employee type is required!</span>
                            </div>
                            
                        </div>
                        
                        <!-- Start Date Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Start Date:</label>
                            <div class="col-sm-4">
                                <div class="row">
                                    <div class="col-xs-3" style="width: 291px;">
                                        <input type="date" class="form-control" id="editStartDate" name="startDate"disabled>
                                </div>
                                   
                                </div>
                            </div>
                        </div>
                        
                        <!-- Work Experience Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Work Experience:</label>
                            <div class="col-sm-6">
                                <label class="radio-inline">
                                    <input type="radio" name="experience" value="Fresher" checked disabled> Fresher
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="experience" value="Junior" disabled> Junior
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="experience" value="Senior" disabled> Senior
                                </label>
                            </div>
                        </div>
                        
                        <!-- Skills Field -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Skills:</label>
                            <div class="col-sm-10">
                                
                                   
                                        <input type="text" class="form-control" id="editSkills" name="skills" value="<%= employee.Skills ? employee.Skills.join(', ') : '' %>"disabled>
                                    
                                
                            </div>
                        </div>
                    </div>
                </div>
               
                </form>
            </div>
        </div>
    </div>
</div>
</html>
<script>
    $(document).ready(function () {
       // Hiển thị thông báo flash message
       <% if (messages && messages.success) { %>
            showAlert('<%= messages.success %>', 'success');
        <% } else if (messages && messages.error) { %>
            showAlert('<%= messages.error %>', 'danger');
        <% } %>
        
        // Hàm hiển thị thông báo
        function showAlert(message, type) {
            var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">';
            alertHtml += '<button type="button" class="close" data-dismiss="alert" aria-label="Close">';
            alertHtml += '<span aria-hidden="true">&times;</span></button>';
            alertHtml += message + '</div>';
            $('.page-header').after(alertHtml);
            
            // Tự động ẩn sau 5 giây
            setTimeout(function() {
                $('.alert').fadeOut('slow', function() {
                    $(this).remove();
                });
            }, 5000);
        }
        
        // Khởi tạo giá trị cho form khi mở modal
        $('#editProfileModal').on('show.bs.modal', function () {
            // Thiết lập các giá trị cơ bản
            setFormValue('editName', '<%= employee.name || "" %>');
            setFormValue('editEmail', '<%= employee.email || "" %>');
            setFormValue('editGender', '<%= employee.gender || "" %>');
            setFormValue('editbirthName', '<%= employee.birthName || "" %>');

            setFormValue('editDesignation', '<%= employee.designation || "" %>');
           
            setFormValue('editSupervisor', '<%= employee.supervisor || "" %>');
            setFormValue('editDateOfBirth', '<%= employee.dateOfBirth ? moment(employee.dateOfBirth).format("YYYY-MM-DD") : "" %>');
            setFormValue('editBirthplace', '<%= employee.birthplace || "" %>');
            setFormValue('editProvince', '<%= employee.province || "" %>');
            setFormValue('editDistrict', '<%= employee.district || "" %>');
            setFormValue('editDetailedAddress', '<%= employee.detailedAddress || "" %>');
            setFormValue('editIdNumber', '<%= employee.idNumber || "" %>');
            setFormValue('editPersonalEmail', '<%= employee.officeEmail || "" %>');
            setFormValue('editJobId', '<%= employee.jobId || "" %>');
            setFormValue('editContactNumber', '<%= employee.contactNumber || "" %>');
            setFormValue('editDepartment', '<%= employee.department || "HR & Administration" %>');
            setFormValue('editExperience', '<%= employee.experience || "Senior" %>');
            setFormValue('editSupervisor', '<%= employee.supervisor || "" %>');
            setFormValue('editSkills', '<%= employee.Skills ? employee.Skills.join(", ") : "" %>');
               // Set department value if it exists
               var deptValue = '<%= employee.department || "HR & Administration" %>';
            if (deptValue) {
                $('#editDepartment').val(deptValue);
            } else {
                $('#editDepartment').val('HR & Administration');
            }

            <% if (employee.startDate) { %>
            setFormValue('editStartDate', '<%= moment(employee.startDate).format("YYYY-MM-DD") %>');
            <% } %>
            
            // Thiết lập giá trị loại hình làm việc
            <% if (employee.employeeType) { %>
            setFormValue('editEmployeeType', '<%= employee.employeeType %>');
            <% } else if (employee.employmentType) { %>
            setFormValue('editEmployeeType', '<%= employee.employmentType === "full-time" ? "Full-Time" : "Part-Time" %>');
            <% } %>
            
            // Tải dữ liệu tỉnh
            loadProvincesData();
        });
        
        // Hàm trợ giúp thiết lập giá trị form
        function setFormValue(id, value) {
            $('#' + id).val(value);
        }
        
        // Tối ưu hóa hàm tải dữ liệu tỉnh
        function loadProvincesData() {
            // Cache kết quả trong biến cục bộ
            if (window.provincesData) {
                populateProvinces(window.provincesData);
                return;
            }
            
            $.ajax({
                url: 'https://provinces.open-api.vn/api/?depth=2',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Lưu cache
                    window.provincesData = data;
                    populateProvinces(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading provinces data:', error);
                }
            });
        }
        
        // Tách logic hiển thị tỉnh thành
        function populateProvinces(data) {
            // Sắp xếp tỉnh theo tên
            data.sort(function(a, b) {
                return a.name.localeCompare(b.name);
            });
            
            // Cập nhật dropdown tỉnh
            var $provinceSelect = $('#editProvince');
            $provinceSelect.empty();
            $provinceSelect.append('<option value="">Chọn tỉnh/thành</option>');
            
            $.each(data, function(i, province) {
                $provinceSelect.append('<option value="' + province.name + '" data-code="' + province.code + '">' + province.name + '</option>');
            });
            
            // Thiết lập tỉnh đã chọn
            var currentProvince = '<%= employee.province || "" %>';
            if (currentProvince) {
                $provinceSelect.val(currentProvince);
                // Kích hoạt sự kiện change để tải quận/huyện
                $provinceSelect.trigger('change');
            }
            
            // Xử lý khi thay đổi tỉnh
            $provinceSelect.off('change').on('change', function() {
                var provinceCode = $('option:selected', this).attr('data-code');
                updateDistricts(provinceCode, data);
            });
        }
        
        // Không thay đổi hàm này
        function updateDistricts(provinceCode, provincesData) {
            var $districtSelect = $('#editDistrict');
            $districtSelect.empty();
            $districtSelect.append('<option value="">Chọn quận/huyện</option>');
            
            if (!provinceCode) {
                return;
            }
            
            // Tìm tỉnh đã chọn
            var selectedProvince = provincesData.find(function(province) {
                return province.code == provinceCode;
            });
            
            if (selectedProvince && selectedProvince.districts) {
                // Sắp xếp quận/huyện theo tên
                selectedProvince.districts.sort(function(a, b) {
                    return a.name.localeCompare(b.name);
                });
                
                // Thêm quận/huyện vào dropdown
                $.each(selectedProvince.districts, function(i, district) {
                    $districtSelect.append('<option value="' + district.name + '">' + district.name + '</option>');
                });
                
                // Thiết lập quận/huyện đã chọn
                var currentDistrict = '<%= employee.district || "" %>';
                if (currentDistrict) {
                    $districtSelect.val(currentDistrict);
                }
            }
        }
    });
</script>
        <!-- Thêm CSS cho trang profile -->
        <style>
            /* Styles for profile page */
            .profile-container {
                margin-top: 20px;
            }
            .profile-card {
                border: 1px solid #ddd;
                border-radius: 5px;
                overflow: hidden;
                margin-bottom: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            
            .employment-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(255,255,255,0.8);
                color: #333;
                padding: 5px 10px;
                border-radius: 3px;
                font-size: 12px;
                font-weight: bold;
            }
            .profile-body {
                padding: 20px;
                background-color: #f9f9f9;
            }
            .profile-image {
                position: relative;
                z-index: 2;
                text-align: center;
                margin-bottom: 15px;
            }
            .profile-image img {
                width: 120px;
                height: 120px;
                border: 5px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                margin-top: -60px;
                display: inline-block;
            }
            .profile-name {
                font-size: 24px;
                margin-bottom: 5px;
            }
            .profile-id {
                color: #666;
                margin-bottom: 15px;
            }
            .profile-details {
                text-align: left;
            }
            .profile-details p {
                margin-bottom: 10px;
            }
            .profile-details i {
                margin-right: 10px;
                width: 16px;
                color: #3498db;
            }
            .info-box {
                display: flex;
                background-color: #e8f4fc;
                border-radius: 5px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .info-box-icon {
                font-size: 24px;
                margin-right: 15px;
                color: #3498db;
            }
            .info-box-content h4 {
                margin-top: 0;
                margin-bottom: 5px;
                font-size: 16px;
                color: #555;
            }
            .info-box-content p {
                margin: 0;
                font-size: 16px;
                font-weight: bold;
            }
            .panel-info > .panel-heading {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background-color: #d9edf7;
                color: #31708f;
            }
            .panel-title {
                margin: 0;
            }
            .btn-edit {
                padding: 2px 8px;
            }
            .row.mb-3 {
                margin-bottom: 15px;
            }
            .badge-info {
                background-color: #3498db;
                margin-right: 5px;
                padding: 5px 10px;
                border-radius: 3px;
            }
        </style>
    </body>
    <style>
        .file-input {
           display: none;
       }
       .thumbnail {
           border: 1px solid #ddd;
           display: flex;
           align-items: center;
           justify-content: center;
           background-color: #f5f5f5;
       }
       .breadcrumb {
           background-color: transparent;
           padding-left: 0;
       }
       .panel-title {
           font-weight: bold;
       }
       .form-group {
           margin-bottom: 15px;
       }
       .panel {
           margin-bottom: 20px;
       }
       .help-block {
           margin-top: 5px;
           margin-bottom: 0;
       }
       .text-danger {
           color: #a94442;
       }
       .api-error {
           color: #a94442;
           background-color: #f2dede;
           border-color: #ebccd1;
       }
       .error-input {
           border-color: #a94442;
           -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
           box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
           background-color: #fff8f8;
       }
       .error-message {
           color: #a94442;
           margin-top: 5px;
           display: none;
           font-size: 12px;
           font-weight: bold;
           animation: fadeIn 0.3s;
       }
       @keyframes fadeIn {
           from { opacity: 0; }
           to { opacity: 1; }
       }
       .required-field {
           color: #a94442;
           margin-left: 3px;
       }
       /* Add style for form legend */
       .form-legend {
           margin-bottom: 20px;
           padding-bottom: 10px;
           border-bottom: 1px solid #eee;
       }
       .form-legend .text-danger {
           font-size: 14px;
           font-weight: normal;
           margin-left: 10px;
       }
       /* Custom file upload styles */
       .custom-file-upload {
           display: inline-block;
           margin-bottom: 10px;
       }
       #file-name-display {
           display: inline-block;
           vertical-align: middle;
           color: #555;
           font-style: italic;
       }
       /* Checkbox scroll container styles */
       .checkbox-scroll-container {
           border: 1px solid #ccc;
           border-radius: 4px;
           background-color: #fff;
       }
       .checkbox-scroll {
           max-height: 150px;
           overflow-y: auto;
           padding: 10px;
       }
       .checkbox-scroll .checkbox {
           margin-top: 2px;
           margin-bottom: 2px;
       }
       .checkbox-scroll .checkbox label {
           font-weight: normal;
       }
       </style>
       
<!-- CSRF Token Refresh Script -->
<script>
    // CSRF Token Refresh
    $(document).ready(function() {
        $.ajaxSetup({
            headers: {
                'X-CSRF-Token': '<%= csrfToken %>'
            }
        });
        
        // Đặt token vào form chính
        var csrfToken = '<%= csrfToken %>';
        $('input[name="_csrf"]').val(csrfToken);
        
        // Kiểm tra và làm mới token mỗi 10 phút
        setInterval(function() {
            $.get('/refresh-csrf', function(data) {
                $('input[name="_csrf"]').val(data.csrfToken);
            });
        }, 10 * 60 * 1000); // 10 phút
        
        // Image preview
        $("#photo").change(function() {
            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#preview-image').attr('src', e.target.result);
                }
                reader.readAsDataURL(this.files[0]);
                
                // Hiển thị tên file đã chọn
                $('#file-name-display').text(this.files[0].name);
            } else {
                // Reset về giá trị mặc định nếu không có file nào được chọn
                $('#preview-image').attr('src', 'https://via.placeholder.com/150');
                $('#file-name-display').text('No file chosen');
            }
        });
        
        // Auto-scroll to form validation errors if any
        if ($('.text-danger').length > 0) {
            $('html, body').animate({
                scrollTop: $('.text-danger').first().offset().top - 100
            }, 200);
        }
        
        // Real-time validation for required fields
        $('input[required], select[required]').on('blur', function() {
            if (!this.value.trim()) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').show();
            } else {
                $(this).removeClass('error-input');
                $(this).closest('.form-group').find('.error-message').hide();
            }
        });
        
        // Show validation message on required select fields
        $('select[required]').on('change', function() {
            if (!this.value) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').show();
            } else {
                $(this).removeClass('error-input');
                $(this).closest('.form-group').find('.error-message').hide();
            }
        });
        
        // Validate form fields before submit
        $('#employee-form').on('submit', function(e) {
            e.preventDefault();
            let hasErrors = false;
            
            // Clear all error messages
            $('.error-message').hide();
            $('.error-input').removeClass('error-input');
            
            // Phone number validation
            const phoneNumber = $('input[name="contactNumber"]').val().trim();
            const phoneRegex = /^[1-9]\d{8}$/;
            if (phoneNumber && !phoneRegex.test(phoneNumber)) {
                $('input[name="contactNumber"]').addClass('error-input');
                if (phoneNumber.length !== 9) {
                    $('input[name="contactNumber"]').closest('.form-group').find('.error-message').text('Phone number must be exactly 9 digits').show();
                } else {
                    $('input[name="contactNumber"]').closest('.form-group').find('.error-message').text('Invalid format. Must start with a digit from 1-9').show();
                }
                hasErrors = true;
            }
            
            // ... existing code ...
            
            if (hasErrors) {
                e.preventDefault();
                // Scroll to first error
                $('html, body').animate({
                    scrollTop: $('.error-input').first().offset().top - 100
                }, 200);
                return false;
            }
            
            // Trim khoảng trắng đầu/cuối cho email
            var emailInput = $('input[name="email"]');
            emailInput.val($.trim(emailInput.val()));
            
            // Xử lý viết hoa chữ cái đầu cho first name, last name và birth name
            var firstNameInput = $('input[name="firstName"]');
            var lastNameInput = $('input[name="lastName"]');
            var birthNameInput = $('input[name="birthName"]');
            
            // Hàm format viết hoa chữ cái đầu và các chữ sau dấu cách
            function toTitleCase(str) {
                if (!str) return str;
                str = $.trim(str); // Trim khoảng trắng
                return str.split(' ').map(function(word) {
                    if (word.length > 0) {
                        return word[0].toUpperCase() + word.substring(1).toLowerCase();
                    }
                    return '';
                }).join(' ');
            }
            
            // Áp dụng định dạng viết hoa chữ cái đầu
            firstNameInput.val(toTitleCase(firstNameInput.val()));
            lastNameInput.val(toTitleCase(lastNameInput.val()));
            
            // Chỉ xử lý birth name nếu có giá trị
            if (birthNameInput.val()) {
                birthNameInput.val(toTitleCase(birthNameInput.val()));
            }
            
            return true; // cho phép form submit
        });
        
        // Apply error validation on page load for required fields that are empty
        setTimeout(function() {
            $('form input[required]:visible, form select[required]:visible').filter(function() {
                return !this.value.trim();
            }).each(function() {
                $(this).addClass('error-input');
            });
        }, 500);
        
        // Custom Gmail validation
        $('input[name="email"]').on('input blur', function() {
            const value = $(this).val().trim();
            const gmailRegex = /^[a-z0-9](\.?[a-z0-9]){5,}@gmail\.com$/i;
            
            if (value && !gmailRegex.test(value)) {
                $(this).addClass('error-input');
                // Update error message text
                const errorMsg = $(this).closest('.form-group').find('.error-message');
                errorMsg.text('Please enter a valid Gmail address (example: username@gmail.com)');
                errorMsg.show();
            } else if (!value) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').text('Email address is required!').show();
            } else {
                $(this).removeClass('error-input');
                $(this).closest('.form-group').find('.error-message').hide();
            }
        });
        
        // Custom company email validation
        $('input[name="officeEmail"]').on('input blur', function() {
            const value = $(this).val().trim();
            const emailRegex = /^[a-z0-9](\.?[a-z0-9_-]){2,}@([a-z0-9-]+\.)+[a-z]{2,6}$/i;
            
            if (value && !emailRegex.test(value)) {
                $(this).addClass('error-input');
                // Update error message text
                const errorMsg = $(this).closest('.form-group').find('.error-message');
                errorMsg.text('Please enter a valid company email address');
                errorMsg.show();
            } else if (!value) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').text('Office email is required!').show();
            } else {
                $(this).removeClass('error-input');
                $(this).closest('.form-group').find('.error-message').hide();
            }
        });
        
        // Real-time phone number validation
        $('input[name="contactNumber"]').on('input blur', function() {
            const value = $(this).val().trim();
            // The pattern validates the first digit must be 1-9 followed by 8 digits
            const phoneRegex = /^[1-9]\d{8}$/;
            
            if (value && value.length !== 9) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').text('Phone number must be exactly 9 digits').show();
            } else if (value && !phoneRegex.test(value)) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').text('Invalid format. Must start with a digit from 1-9').show();
            } else if (!value) {
                $(this).addClass('error-input');
                $(this).closest('.form-group').find('.error-message').text('Phone number is required!').show();
            } else {
                $(this).removeClass('error-input');
                $(this).closest('.form-group').find('.error-message').hide();
            }
        });
        
        // Ghi chú về việc tải dữ liệu tỉnh thành - không cần gọi tại đây nữa
        console.log("jQuery ready, waiting for provinces.js to load data");
        // Hàm loadProvincesDataImmediately đã được gọi tự động từ provinces.js
        
        // Function to find province by code and load fresh data
        async function loadProvinceByCode(provinceName) {
            if (!window.provincesData) return null;
            
            const province = window.provincesData.find(function(p) { 
                return p.name === provinceName; 
            });
            if (!province || !province.code) return null;
            
            try {
                const response = await fetch('https://provinces.open-api.vn/api/p/' + province.code + '?depth=2');
                if (!response.ok) throw new Error('API request failed');
                return await response.json();
            } catch (error) {
                console.error('Error loading province data:', error);
                return null;
            }
        }

        // Xử lý submit form để chuyển 3 dropdown date thành 1 ngày ISO
        $('#employee-form').on('submit', function(e) {
            // Xử lý Date of Birth
            const dobDay = $('select[name="dobDay"]').val();
            const dobMonth = $('select[name="dobMonth"]').val();
            const dobYear = $('select[name="dobYear"]').val();
            
            if (dobDay && dobMonth && dobYear) {
                // Format tháng và ngày để đảm bảo có 2 chữ số
                const formattedDay = dobDay.toString().padStart(2, '0');
                const formattedMonth = dobMonth.toString().padStart(2, '0');
                
                // Tạo ngày ISO (yyyy-mm-dd)
                const isoDate = `${dobYear}-${formattedMonth}-${formattedDay}`;
                
                // Tạo input ẩn chứa giá trị ISO
                $('<input>').attr({
                    type: 'hidden',
                    name: 'dateOfBirth',
                    value: isoDate
                }).appendTo(this);
            } else if(dobDay || dobMonth || dobYear) {
                // Nếu chỉ nhập một phần của ngày, hiển thị lỗi
                e.preventDefault();
                alert('Vui lòng nhập đầy đủ ngày, tháng, năm cho ngày sinh');
                return false;
            }
            
            // Xử lý Start Date (nếu có)
            const startDay = $('select[name="startDay"]').val();
            const startMonth = $('select[name="startMonth"]').val();
            const startYear = $('select[name="startYear"]').val();
            
            // Chỉ xử lý nếu cả 3 giá trị đều có hoặc đều không có
            if (startDay && startMonth && startYear) {
                // Format tháng và ngày để đảm bảo có 2 chữ số
                const formattedStartDay = startDay.toString().padStart(2, '0');
                const formattedStartMonth = startMonth.toString().padStart(2, '0');
                
                // Tạo ngày ISO (yyyy-mm-dd)
                const isoStartDate = `${startYear}-${formattedStartMonth}-${formattedStartDay}`;
                
                // Tạo input ẩn chứa giá trị ISO
                $('<input>').attr({
                    type: 'hidden',
                    name: 'startDate',
                    value: isoStartDate
                }).appendTo(this);
            } else if(startDay || startMonth || startYear) {
                // Nếu chỉ nhập một phần của ngày, hiển thị lỗi
                e.preventDefault();
                alert('Vui lòng nhập đầy đủ ngày, tháng, năm cho ngày bắt đầu');
                return false;
            }
            
            // Xử lý chuyển đổi mã tỉnh/thành phố và quận/huyện thành tên để lưu vào database
            const provinceSelect = $('select[name="province"]');
            const districtSelect = $('select[name="district"]');
            
            if (provinceSelect.val()) {
                // Tạo input ẩn với tên tỉnh
                const provinceName = provinceSelect.find('option:selected').text();
                $('<input>').attr({
                    type: 'hidden',
                    name: 'provinceActual',
                    value: provinceName
                }).appendTo(this);
            }
            
            if (districtSelect.val()) {
                // Tạo input ẩn với tên quận/huyện
                const districtName = districtSelect.find('option:selected').text();
                $('<input>').attr({
                    type: 'hidden',
                    name: 'districtActual',
                    value: districtName
                }).appendTo(this);
            }
            
            return true;
        });
        
        // Convert date inputs to DD/MM/YY format
        $('.date-input').each(function() {
            // Store the ISO format for form submission
            $(this).attr('data-iso-value', $(this).val());
            
            // Add change event to store ISO value when changed
            $(this).on('change', function() {
                $(this).attr('data-iso-value', $(this).val());
                
                // If there's a value, format it as DD/MM/YY for display
                if ($(this).val()) {
                    var date = new Date($(this).val());
                    var day = ("0" + date.getDate()).slice(-2);
                    var month = ("0" + (date.getMonth() + 1)).slice(-2);
                    var year = date.getFullYear().toString().substr(-2);
                    
                    // Format for display only
                    var formattedDate = day + '/' + month + '/' + year;
                    $(this).attr('data-formatted', formattedDate);
                }
            });
        });
});
</script>
    <%- include('../partials/modals') %>
</html>
