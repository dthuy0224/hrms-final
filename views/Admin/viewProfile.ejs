<!DOCTYPE html>
<html>
    <%- include('../partials/header') %>

    <body>
        <nav class="navbar navbar-default no-margin">
    <!-- Brand and toggle get grouped for better mobile display -->

    <div class="navbar-header fixed-brand">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" id="menu-toggle">
            <span class="glyphicon glyphicon-th-large" style="margin-left:5px;" aria-hidden="true"></span>
        </button>
        <a class="navbar-brand" href="#"> <%= userName %></a>
    </div><!-- navbar-header-->

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <button class="navbar-toggle collapse in" data-toggle="collapse" id="menu-toggle-2"><span
                            class="glyphicon glyphicon-th-large" aria-hidden="true"></span></button>
            </li>
            <li class="navbar-brand">
                <form action="/logout" method="get">
                    <button id="logout" type="submit" style="margin-top: -3px;" class="btn btn-default"><i
                                class="fa fa-sign-out" aria-hidden="true"></i> Logout
                    </button>
                </form>
            </li>
        </ul>
    </div><!-- bs-example-navbar-collapse-1 -->
</nav>
<div id="wrapper">
    <!-- Sidebar -->
    <%- include('../partials/adminSidebar') %>

            <!-- /#sidebar-wrapper -->
            <!-- Page Content -->
            <div id="page-content-wrapper">
                <div class="container-fluid xyz">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="page-header">
                                <ol class="breadcrumb">
                                    <li><a href="/admin">Dashboard</a></li>
                                    <li class="active">My Profile</li>
                                </ol>
                                <h3>Employee Profile</h3>
                            </div>

                            <div class="profile-container">
                                <div class="row">
                                    <!-- Left side profile card -->
                                    <div class="col-md-4">
                                        <div class="profile-card">
                                            <div class="profile-header" style="background-color: #222;">
                                                <div class="employment-badge">
                                                    <% if (employee.employeeType) { %>
                                                        <%= employee.employeeType %>
                                                    <% } else if (employee.employmentType) { %>
                                                        <%= employee.employmentType === 'full-time' ? 'Full-Time' : 'Part-Time' %>
                                                    <% } else { %>
                                                        Full-Time
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="profile-body text-center">
                                                <div class="profile-image">
                                                    <% if(employee.photo) { %>
                                                        <img src="/uploads/<%= employee.photo %>" alt="<%= employee.name %>" class="img-circle">
                                                    <% } else { %>
                                                        <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Default Avatar" class="img-circle">
                                                    <% } %>
                                                </div>
                                                <h3 class="profile-name"><%= employee.name %></h3>
                                                <p class="profile-id">@<%= employee.jobId || (employee._id.toString().substr(-2)) %></p>
                                                
                                                <hr>
                                                
                                                <div class="profile-details">
                                                    <p>
                                                        <i class="fa fa-briefcase"></i> 
                                                        <%= employee.designation || 'Admin' %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-building"></i> 
                                                        Working at: <%= employee.department || 'HR & Administration' %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-envelope"></i> 
                                            <%= employee.email %>
                                                    </p>
                                                    <p>
                                                        <i class="fa fa-phone"></i> 
                                                        <%= employee.contactNumber %>
                                                    </p>
                                                    <% if (employee.supervisor) { %>
                                                    <p>
                                                        <i class="fa fa-user"></i> 
                                                        Report by: <%= employee.supervisor %>
                                                    </p>
                                                    <% } %>
                                                    <p>
                                                        <i class="fa fa-calendar"></i> 
                                                        Birthday on: <%= moment(employee.dateOfBirth).format('DD MMMM') %>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right side information panels -->
                                    <div class="col-md-8">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="info-box">
                                                    <div class="info-box-icon">
                                                        <i class="fa fa-calendar-check-o"></i>
                                                    </div>
                                                    <div class="info-box-content">
                                                        <h4>Start Date</h4>
                                                        <p><%= employee.startDate ? moment(employee.startDate).format('DD MMMM YYYY') : 'Not specified' %></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="info-box">
                                                    <div class="info-box-icon">
                                                        <i class="fa fa-birthday-cake"></i>
                                                    </div>
                                                    <div class="info-box-content">
                                                        <h4>Date of Birth</h4>
                                                        <p><%= moment(employee.dateOfBirth).format('DD MMMM YYYY') %></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Personal Information Panel -->
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Personal information</h3>
                                                <button type="button" class="btn btn-default btn-xs btn-edit" data-toggle="modal" data-target="#editProfileModal">
                                                    <i class="fa fa-pencil"></i> Edit
                                                </button>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Name:</strong></div>
                                                    <div class="col-md-9"><%= employee.name %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Gender:</strong></div>
                                                    <div class="col-md-9">
                                                        <%= employee.gender ? (employee.gender.charAt(0).toUpperCase() + employee.gender.slice(1)) : 'Not specified' %>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Birthplace:</strong></div>
                                                    <div class="col-md-9"><%= employee.birthplace || 'Not specified' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Address:</strong></div>
                                                    <div class="col-md-9">
                                                        <% if (employee.detailedAddress || employee.district || employee.province) { %>
                                                            <%= [employee.detailedAddress, employee.district, employee.province].filter(Boolean).join(', ') %>
                                                        <% } else { %>
                                                            Not specified
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>ID Number:</strong></div>
                                                    <div class="col-md-9"><%= employee.idNumber || 'Not specified' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Personal Email:</strong></div>
                                                    <div class="col-md-9"><%= employee.email %></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Job Information Panel -->
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Job information</h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Job ID:</strong></div>
                                                    <div class="col-md-9"><%= employee.jobId || 'Not assigned' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Job Title:</strong></div>
                                                    <div class="col-md-9"><%= employee.designation || 'Admin' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Department:</strong></div>
                                                    <div class="col-md-9"><%= employee.department || 'HR & Administration' %></div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Work Experience:</strong></div>
                                                    <div class="col-md-9"><%= employee.experience || 'Senior' %></div>
                                                </div>
                                                <% if (employee.Skills && employee.Skills.length > 0) { %>
                                                <div class="row mb-3">
                                                    <div class="col-md-3"><strong>Skills:</strong></div>
                                                    <div class="col-md-9">
                                                        <% employee.Skills.forEach(function(skill, index) { %>
                                                            <% if (skill !== "") { %>
                                                                <span class="badge badge-info"><%= skill %></span>
                                                            <% } %>
                                                        <% }); %>
                                                    </div>
                                                </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /#page-content-wrapper -->
        </div>
        <!-- /#wrapper -->
        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.js" charset="UTF-8"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js" charset="UTF-8"></script>

        <script src="/javascripts/sidebar_menu.js"></script>
        <script>
            $(document).ready(function () {
                // Hiển thị thông báo flash message
                <% if (messages && messages.success) { %>
                    showAlert('<%= messages.success %>', 'success');
                <% } else if (messages && messages.error) { %>
                    showAlert('<%= messages.error %>', 'danger');
                <% } %>
                
                // Hàm hiển thị thông báo
                function showAlert(message, type) {
                    var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">';
                    alertHtml += '<button type="button" class="close" data-dismiss="alert" aria-label="Close">';
                    alertHtml += '<span aria-hidden="true">&times;</span></button>';
                    alertHtml += message + '</div>';
                    $('.page-header').after(alertHtml);
                    
                    // Tự động ẩn sau 5 giây
                    setTimeout(function() {
                        $('.alert').fadeOut('slow', function() {
                            $(this).remove();
                        });
                    }, 5000);
                }
                
                // Khởi tạo giá trị cho form khi mở modal
                $('#editProfileModal').on('show.bs.modal', function () {
                    // Thiết lập các giá trị cơ bản
                    setFormValue('editGender', '<%= employee.gender || "" %>');
                    setFormValue('editBirthplace', '<%= employee.birthplace || "" %>');
                    setFormValue('editProvince', '<%= employee.province || "" %>');
                    setFormValue('editDistrict', '<%= employee.district || "" %>');
                    setFormValue('editDetailedAddress', '<%= employee.detailedAddress || "" %>');
                    setFormValue('editIdNumber', '<%= employee.idNumber || "" %>');
                    setFormValue('editJobId', '<%= employee.jobId || "" %>');
                    setFormValue('editContactNumber', '<%= employee.contactNumber || "" %>');
                    setFormValue('editDepartment', '<%= employee.department || "" %>');
                    setFormValue('editExperience', '<%= employee.experience || "Senior" %>');
                    
                    <% if (employee.startDate) { %>
                    setFormValue('editStartDate', '<%= moment(employee.startDate).format("YYYY-MM-DD") %>');
                    <% } %>
                    
                    // Thiết lập giá trị loại hình làm việc
                    <% if (employee.employeeType) { %>
                    setFormValue('editEmployeeType', '<%= employee.employeeType %>');
                    <% } else if (employee.employmentType) { %>
                    setFormValue('editEmployeeType', '<%= employee.employmentType === "full-time" ? "Full-Time" : "Part-Time" %>');
                    <% } %>
                    
                    // Tải dữ liệu tỉnh
                    loadProvincesData();
                });
                
                // Hàm trợ giúp thiết lập giá trị form
                function setFormValue(id, value) {
                    $('#' + id).val(value);
                }
                
                // Tối ưu hóa hàm tải dữ liệu tỉnh
                function loadProvincesData() {
                    // Cache kết quả trong biến cục bộ
                    if (window.provincesData) {
                        populateProvinces(window.provincesData);
                        return;
                    }
                    
                    $.ajax({
                        url: 'https://provinces.open-api.vn/api/?depth=2',
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            // Lưu cache
                            window.provincesData = data;
                            populateProvinces(data);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading provinces data:', error);
                        }
                    });
                }
                
                // Tách logic hiển thị tỉnh thành
                function populateProvinces(data) {
                    // Sắp xếp tỉnh theo tên
                    data.sort(function(a, b) {
                        return a.name.localeCompare(b.name);
                    });
                    
                    // Cập nhật dropdown tỉnh
                    var $provinceSelect = $('#editProvince');
                    $provinceSelect.empty();
                    $provinceSelect.append('<option value="">Chọn tỉnh/thành</option>');
                    
                    $.each(data, function(i, province) {
                        $provinceSelect.append('<option value="' + province.name + '" data-code="' + province.code + '">' + province.name + '</option>');
                    });
                    
                    // Thiết lập tỉnh đã chọn
                    var currentProvince = '<%= employee.province || "" %>';
                    if (currentProvince) {
                        $provinceSelect.val(currentProvince);
                        // Kích hoạt sự kiện change để tải quận/huyện
                        $provinceSelect.trigger('change');
                    }
                    
                    // Xử lý khi thay đổi tỉnh
                    $provinceSelect.off('change').on('change', function() {
                        var provinceCode = $('option:selected', this).attr('data-code');
                        updateDistricts(provinceCode, data);
                    });
                }
                
                // Không thay đổi hàm này
                function updateDistricts(provinceCode, provincesData) {
                    var $districtSelect = $('#editDistrict');
                    $districtSelect.empty();
                    $districtSelect.append('<option value="">Chọn quận/huyện</option>');
                    
                    if (!provinceCode) {
                        return;
                    }
                    
                    // Tìm tỉnh đã chọn
                    var selectedProvince = provincesData.find(function(province) {
                        return province.code == provinceCode;
                    });
                    
                    if (selectedProvince && selectedProvince.districts) {
                        // Sắp xếp quận/huyện theo tên
                        selectedProvince.districts.sort(function(a, b) {
                            return a.name.localeCompare(b.name);
                        });
                        
                        // Thêm quận/huyện vào dropdown
                        $.each(selectedProvince.districts, function(i, district) {
                            $districtSelect.append('<option value="' + district.name + '">' + district.name + '</option>');
                        });
                        
                        // Thiết lập quận/huyện đã chọn
                        var currentDistrict = '<%= employee.district || "" %>';
                        if (currentDistrict) {
                            $districtSelect.val(currentDistrict);
                        }
                    }
                }
            });
        </script>

        <style>
            /* Profile Styles */
            .profile-container {
                margin-top: 20px;
            }
            
            /* Profile Card Styles */
            .profile-card {
                background-color: #fff;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
                overflow: hidden;
            }
            
            .profile-header {
                background-color: #3498db;
                height: 100px;
                position: relative;
            }
            
            .employment-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: #FF9800;
                color: white;
                padding: 3px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .profile-image {
                margin-top: 20px;
                margin-bottom: 20px;
            }
            
            .profile-image img {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                border: 4px solid white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .profile-name {
                margin-bottom: 5px;
                font-weight: bold;
            }
            
            .profile-id {
                color: #777;
                margin-bottom: 20px;
            }
            
            .profile-body {
                padding: 20px;
            }
            
            .profile-details {
                text-align: left;
            }
            
            .profile-details p {
                margin-bottom: 10px;
            }
            
            .profile-details i {
                width: 20px;
                margin-right: 10px;
                color: #42a5f5;
            }
            
            /* Info Boxes */
            .info-box {
                display: flex;
                align-items: center;
                background-color: #e3f2fd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
                min-height: 100px;
            }
            
            .info-box-icon {
                font-size: 24px;
                margin-right: 15px;
                width: 50px;
                height: 50px;
                background-color: #42a5f5;
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .info-box-content h4 {
                margin-top: 0;
                font-size: 16px;
                color: #333;
            }
            
            .info-box-content p {
                margin-bottom: 0;
                font-size: 18px;
                font-weight: bold;
            }
            
            /* Panel styles */
            .panel-info {
                border-color: #3498db;
            }
            
            .panel-info > .panel-heading {
                background-color: #42a5f5;
                color: white;
                border-color: #42a5f5;
                position: relative;
            }
            
            .panel-heading .btn-edit {
                position: absolute;
                right: 10px;
                top: 7px;
                padding: 3px 8px;
                font-size: 12px;
            }
            
            .row.mb-3 {
                margin-bottom: 15px;
            }
            
            .row.mb-4 {
                margin-bottom: 20px;
            }
            
            /* Badge styles */
            .badge-info {
                background-color: #42a5f5;
                color: white;
                margin-right: 5px;
                padding: 5px 10px;
                border-radius: 3px;
                display: inline-block;
                margin-bottom: 5px;
            }
            
            /* Breadcrumb styles */
            .breadcrumb {
                background-color: transparent;
                padding-left: 0;
            }
            
            /* Page header */
            .page-header {
                margin-bottom: 20px;
            }
            
            /* Panel heading style */
            .panel-heading {
                padding: 12px 15px;
            }
            
            .panel-title {
                font-size: 16px;
                font-weight: 600;
            }
        </style>
 <script>
  document.addEventListener('DOMContentLoaded', function () {
    const path = window.location.pathname;
    const menuLinks = document.querySelectorAll('#menu li a');
  
    menuLinks.forEach(link => {
      const li = link.parentElement;
      if (link.getAttribute('href') === path) {
        li.classList.add('active');
      } else {
        li.classList.remove('active');
      }
    });
  });
  </script>

    </body>
    
    <!-- Mark Attendance Modal -->
    <div id="myModal2" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <form method="post" action="/admin/mark-attendance">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            &times;
                        </button>
                        <h4 class="modal-title">Mark Attendance</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to mark attendance?</p>
                    </div>
                    <div class="modal-footer">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
<button type="submit" class="btn btn-default">Yes</button>                        <button type="reset" class="btn btn-default" data-dismiss="modal">
                            Cancel
                        </button>
                        
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" action="/admin/update-profile-bypass" enctype="multipart/form-data">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Edit Profile</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-md-6">
                                <h4>Personal Information</h4>
                                
                                <div class="form-group">
                                    <label for="editGender">Gender:</label>
                                    <select class="form-control" id="editGender" name="gender">
                                        <option value="">Select gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editBirthplace">Birthplace:</label>
                                    <input type="text" class="form-control" id="editBirthplace" name="birthplace" placeholder="City/Province">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editProvince">Province:</label>
                                    <select class="form-control" id="editProvince" name="province">
                                        <option value="">Select province</option>
                                        <!-- Provinces will be loaded via AJAX -->
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editDistrict">District:</label>
                                    <select class="form-control" id="editDistrict" name="district">
                                        <option value="">Select district</option>
                                        <!-- Districts will be loaded via AJAX -->
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editDetailedAddress">Detailed Address:</label>
                                    <textarea class="form-control" id="editDetailedAddress" name="detailedAddress" rows="2" placeholder="Street address"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editIdNumber">ID Number:</label>
                                    <input type="text" class="form-control" id="editIdNumber" name="idNumber" placeholder="National ID">
                                </div>
                            </div>
                            
                            <!-- Job Information -->
                            <div class="col-md-6">
                                <h4>Job Information</h4>
                                
                                <div class="form-group">
                                    <label for="editJobId">Job ID:</label>
                                    <input type="text" class="form-control" id="editJobId" name="jobId" placeholder="Example: ADM001">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editContactNumber">Contact Number:</label>
                                    <input type="text" class="form-control" id="editContactNumber" name="contactNumber" placeholder="Phone number">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editStartDate">Start Date:</label>
                                    <input type="date" class="form-control" id="editStartDate" name="startDate">
                                </div>
                                
                                <div class="form-group">
                                    <label for="editDepartment">Department:</label>
                                    <select class="form-control" id="editDepartment" name="department">
                                        <option value="">Select department</option>
                                        <option value="HR & Administration">HR & Administration</option>
                                        <option value="Software Development">Software Development</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Finance">Finance</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editEmployeeType">Employment Type:</label>
                                    <select class="form-control" id="editEmployeeType" name="employeeType">
                                        <option value="">Select employment type</option>
                                        <option value="Full-Time">Full-Time</option>
                                        <option value="Part-Time">Part-Time</option>
                                    </select>
                                </div>
                                
                        <div class="form-group">
                                    <label for="editExperience">Work Experience:</label>
                                    <select class="form-control" id="editExperience" name="experience">
                                        <option value="Fresher">Fresher</option>
                                        <option value="Junior">Junior</option>
                                        <option value="Senior">Senior</option>
                            </select>
                        </div>
                                
                        <div class="form-group">
                                    <label for="editPhoto">Profile Photo:</label>
                                    <input type="file" id="editPhoto" name="photo" accept="image/*">
                                    <p class="help-block">Upload a new profile photo (optional)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</html>