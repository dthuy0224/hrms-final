<!DOCTYPE html>
<html>
    <%- include('../partials/header') %>
    <link rel="stylesheet" href="/stylesheets/thuongTitle.css" />
    <body>
        <nav class="navbar navbar-default no-margin">
    <!-- Brand and toggle get grouped for better mobile display -->

    <div class="navbar-header fixed-brand">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" id="menu-toggle">
            <span class="glyphicon glyphicon-th-large" style="margin-left:5px;" aria-hidden="true"></span>
        </button>
        <a class="navbar-brand" href="#"> <%= userName %></a>
    </div><!-- navbar-header-->

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <button class="navbar-toggle collapse in" data-toggle="collapse" id="menu-toggle-2"><span
                            class="glyphicon glyphicon-th-large" aria-hidden="true"></span></button>
            </li>
            <li class="navbar-brand">
                <form action="/logout" method="get">
                    <button id="logout" type="submit" style="margin-top: -3px;" class="btn btn-default"><i
                                class="fa fa-sign-out" aria-hidden="true"></i> Logout
                    </button>
                </form>
            </li>
        </ul>
    </div><!-- bs-example-navbar-collapse-1 -->
</nav>
<div id="wrapper">
    <!-- Sidebar -->
    <%- include('../partials/adminSidebar') %>

            <!-- /#sidebar-wrapper -->
            <!-- Page Content -->
            <div id="page-content-wrapper">
                <div class="container-fluid xyz">
                    <div class="row">
                        <div class="col-lg-12">
                            <div style="margin-bottom: 20px;">
                                <h1 class="ThuongTitleAttendanceAdmin"><i class="fa fa-angle-right"></i> Attendance</h1>
                                <style>
                                    .ThuongTitleAttendanceAdmin {
                                        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                                        font-size: 1.6em;
                                        padding-bottom: 9px;
                                        margin: 10px 0 20px;
                                        border-bottom: 1px solid #eee;
                                        font-weight: bold;
                                        color: #333;
                                      }
                                      </style>
                                <p>Month: <%= ['January', 'February', 'March', 'April', 'May',
                                            'June', 'July', 'August', 'September', 'October', 'November', 'December'][month-1] %>, <%= year %></p>
                            </div>

                            <!-- Attendance Statistics Cards -->
                            <div class="row" style="margin-bottom: 25px;">
                                <div class="col-md-3">
                                    <div class="panel panel-default" style="border: 1px solid #28a745; border-radius: 5px;">
                                        <div class="panel-body text-center" style="padding: 15px;">
                                            <h4 style="color: #28a745; margin-bottom: 10px; font-weight: bold;">Present</h4>
                                            <h3 style="margin: 0;">
                                                <span id="presentPercentage" style="font-weight: bold; font-size: 28px;">
                                                <%= (statsData.totalDays > 0) ? 
                                                   Math.round((statsData.presentDays / statsData.totalDays) * 100) : 0 %>%</span>
                                                <span style="color: #777; margin: 0 10px;">|</span>
                                                <span id="presentCount"><%= statsData.presentDays %></span>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-default" style="border: 1px solid #e542b7; border-radius: 5px;">
                                        <div class="panel-body text-center" style="padding: 15px;">
                                            <h4 style="color: #e542b7; margin-bottom: 10px; font-weight: bold;">Leave</h4>
                                            <h3 style="margin: 0;">
                                                <span id="leavePercentage" style="font-weight: bold; font-size: 28px;">
                                                <%= (statsData.totalDays > 0) ? 
                                                   Math.round((statsData.leaveDays / statsData.totalDays) * 100) : 0 %>%</span>
                                                <span style="color: #777; margin: 0 10px;">|</span>
                                                <span id="leaveCount"><%= statsData.leaveDays %></span>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-default" style="border: 1px solid #fd7e14; border-radius: 5px;">
                                        <div class="panel-body text-center" style="padding: 15px;">
                                            <h4 style="color: #fd7e14; margin-bottom: 10px; font-weight: bold;">Late</h4>
                                            <h3 style="margin: 0;">
                                                <span id="latePercentage" style="font-weight: bold; font-size: 28px;">
                                                <%= (statsData.totalDays > 0) ? 
                                                   Math.round((statsData.lateDays / statsData.totalDays) * 100) : 0 %>%</span>
                                                <span style="color: #777; margin: 0 10px;">|</span>
                                                <span id="lateCount"><%= statsData.lateDays %></span>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="panel panel-default" style="border: 1px solid #17a2b8; border-radius: 5px;">
                                        <div class="panel-body text-center" style="padding: 15px;">
                                            <h4 style="color: #17a2b8; margin-bottom: 10px; font-weight: bold;">On-Time</h4>
                                            <h3 style="margin: 0;">
                                                <span id="onTimePercentage" style="font-weight: bold; font-size: 28px;">
                                                <%= (statsData.totalDays > 0) ? 
                                                   Math.round((statsData.onTimeDays / statsData.totalDays) * 100) : 0 %>%</span>
                                                <span style="color: #777; margin: 0 10px;">|</span>
                                                <span id="onTimeCount"><%= statsData.onTimeDays %></span>
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filter and Export Controls -->
                            <div class="row" style="margin-bottom: 20px;">
                                <div class="col-md-6">
                                    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" 
                                           style="background-color: #222; color: white; border-radius: 20px;">
                                        <i class="fa fa-sort"></i> Sort By
                                    </button>
                                    <div class="dropdown-menu" style="padding: 10px; min-width: 200px;">
                                        <a href="#" class="sort-option" data-sort="name" style="display: block; padding: 5px;">Name</a>
                                        <a href="#" class="sort-option" data-sort="checkin" style="display: block; padding: 5px;">Check In Time</a>
                                        <a href="#" class="sort-option" data-sort="status" style="display: block; padding: 5px;">Status</a>
                                    </div>
                                    
                                    <div class="btn-group" style="margin-left: 10px;">
                                        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" style="border-radius: 20px;">
                                            <i class="fa fa-calendar"></i> <%= ['January', 'February', 'March', 'April', 'May',
                                            'June', 'July', 'August', 'September', 'October', 'November', 'December'][month-1] %>, <%= year %>
                                        </button>
                                        <div class="dropdown-menu" style="padding: 15px; min-width: 250px;">
                                            <form class="form" method="get" action="/admin/employees-attendance">
                                                <div class="form-group">
                                                    <label for="month">Month:</label>
                                                    <select class="form-control" id="month" name="month">
                                                        <option value="1" <%= month==1 ? 'selected' : '' %>>January</option>
                                                        <option value="2" <%= month==2 ? 'selected' : '' %>>February</option>
                                                        <option value="3" <%= month==3 ? 'selected' : '' %>>March</option>
                                                        <option value="4" <%= month==4 ? 'selected' : '' %>>April</option>
                                                        <option value="5" <%= month==5 ? 'selected' : '' %>>May</option>
                                                        <option value="6" <%= month==6 ? 'selected' : '' %>>June</option>
                                                        <option value="7" <%= month==7 ? 'selected' : '' %>>July</option>
                                                        <option value="8" <%= month==8 ? 'selected' : '' %>>August</option>
                                                        <option value="9" <%= month==9 ? 'selected' : '' %>>September</option>
                                                        <option value="10" <%= month==10 ? 'selected' : '' %>>October</option>
                                                        <option value="11" <%= month==11 ? 'selected' : '' %>>November</option>
                                                        <option value="12" <%= month==12 ? 'selected' : '' %>>December</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="year">Year:</label>
                                                    <select class="form-control" id="year" name="year">
                                                        <!-- Filled via JavaScript -->
                                                    </select>
                                                </div>
                                                <button type="submit" class="btn btn-primary btn-block">Apply Filter</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button id="printBtn" class="btn btn-default" style="border-radius: 20px; background-color: #222; color: white;">
                                        <i class="fa fa-print"></i> Print
                                    </button>
                                    <div class="btn-group" style="margin-left: 10px;">
                                        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" style="border-radius: 20px; background-color: #222; color: white;">
                                            <i class="fa fa-download"></i> Export
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-right">
                                            <li><a href="#" id="exportPDF"><i class="fa fa-file-pdf-o"></i> Export as PDF</a></li>
                                            <li><a href="#" id="exportExcel"><i class="fa fa-file-excel-o"></i> Export as Excel</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- For debugging - Show raw employee data -->
                            <div style="margin-bottom: 20px;" id="debugInfo">
                                <div class="alert alert-info">
                                    <span>
                                        <strong>Debug Stats:</strong> 
                                        <span>Number of employees: <%= employees ? employees.length : 0 %></span>
                                        <% if (employees && employees.length > 0) { %>
                                            <span>, First employee: <%= employees[0].employee.name %></span>
                                            <span>, Records: <%= employees[0].attendanceRecords ? employees[0].attendanceRecords.length : 0 %></span>
                                        <% } %>
                                    </span>
                                    <a href="/admin/create-sample-attendance" class="btn btn-warning btn-sm" style="float: right">Create Sample Data</a>
                                </div>
                                <button class="btn btn-info" onclick="$('#rawData').toggle()">Show/Hide Raw Data</button>
                                <pre id="rawData" style="display: none; max-height: 300px; overflow: auto; background: #f5f5f5; padding: 10px; margin-top: 10px; border: 1px solid #ddd;">
Number of employees: <%= employees ? employees.length : 0 %>
<% if (employees && employees.length > 0) { %>
<%= JSON.stringify({
  employee: employees[0].employee,
  records: employees[0].attendanceRecords,
  presentDays: employees[0].presentDays,
  absentDays: employees[0].absentDays,
  leaveDays: employees[0].leaveDays,
  lateDays: employees[0].lateDays,
  onTimeDays: employees[0].onTimeDays,
}, null, 2) %>
<% } %>
                                </pre>
                            </div>

                            <!-- Attendance Table -->
                            <div class="table-responsive" style="margin-top: 20px;">
                                <table class="table table-hover" id="attendanceTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Check In</th>
                                            <th>Check out</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (employees && employees.length > 0) { %>
                                            <% 
                                            // Biến đếm cho ID
                                            let counter = 1;
                                            
                                            // Duyệt qua mỗi nhân viên
                                            employees.forEach(function(empData, index) { 
                                                // Kiểm tra xem có attendanceRecords hay không
                                                if (empData.attendanceRecords && empData.attendanceRecords.length > 0) {
                                                    // Nếu có, hiển thị mỗi bản ghi
                                                    empData.attendanceRecords.forEach(function(record) { 
                                            %>
                                                        <tr class="attendance-row">
                                                            <td><%= counter++ %></td>
                                                            <td><%= empData.employee.name %></td>
                                                            <td><%= record.checkInTime || '--' %></td>
                                                            <td><%= record.checkOutTime || '--' %></td>
                                                            <td>
                                                                <% if (record.status === 'present') { %>
                                                                    <span class="status-badge status-present">Present</span>
                                                                <% } else if (record.status === 'leave') { %>
                                                                    <span class="status-badge status-leave">Leave</span>
                                                                <% } else if (record.status === 'late') { %>
                                                                    <span class="status-badge status-late">Late</span>
                                                                <% } else { %>
                                                                    <span class="status-badge status-unknown"><%= record.status || 'Unknown' %></span>
                                                                <% } %>
                                                            </td>
                                                            <td>
                                                                <button class="btn-edit edit-attendance" data-id="<%= record._id %>">
                                                                    Edit
                                                                </button>
                                                            </td>
                                                        </tr>
                                            <% 
                                                    }); 
                                                } else {
                                                    // Nếu không có bản ghi điểm danh, hiển thị hàng đơn
                                            %>
                                                    <tr class="attendance-row">
                                                        <td><%= counter++ %></td>
                                                        <td><%= empData.employee.name %></td>
                                                        <td>--</td>
                                                        <td>--</td>
                                                        <td>
                                                            <% if (empData.status === 'leave') { %>
                                                                <span class="status-badge status-leave">Leave</span>
                                                            <% } else { %>
                                                                <span class="status-badge status-unknown">No Record</span>
                                                            <% } %>
                                                        </td>
                                                        <td>
                                                            <button class="btn-edit edit-attendance" data-id="<%= empData.employee._id %>">
                                                                Add
                                                            </button>
                                                        </td>
                                                    </tr>
                                            <% 
                                                } 
                                            }); 
                                            %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="6" class="text-center">No employees or attendance records found for this month</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /#page-content-wrapper -->
        </div>
        <!-- /#wrapper -->
        
        <!-- Modal for editing attendance -->
        <div class="modal fade" id="editAttendanceModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Edit Attendance</h4>
                    </div>
                    <div class="modal-body">
                        <form id="editAttendanceForm">
                            <input type="hidden" id="attendanceId" name="attendanceId">
                            <div class="form-group">
                                <label for="statusSelect">Status</label>
                                <select class="form-control" id="statusSelect" name="status">
                                    <option value="present">Present</option>
                                    <option value="leave">Leave</option>
                                    <option value="late">Late</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="checkInTime">Check In Time</label>
                                <input type="time" class="form-control" id="checkInTime" name="checkInTime">
                            </div>
                            <div class="form-group">
                                <label for="checkOutTime">Check Out Time</label>
                                <input type="time" class="form-control" id="checkOutTime" name="checkOutTime">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveAttendanceChanges">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for marking attendance -->
        <div id="myModal2" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <form method="post" action="/admin/mark-attendance">
                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                &times;
                            </button>
                            <h4 class="modal-title">Check-in</h4>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to check in?</p>
                        </div>
                        <div class="modal-footer">
                            <input type="hidden" name="_csrf" value="<%=csrfToken%>" />
      <button type="submit" class="btn btn-default">Yes</button>                      <button type="reset" class="btn btn-default" data-dismiss="modal">
                                Cancel
                            </button>
                            
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for checking out -->
        <div id="checkOutModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <form method="post" action="/admin/check-out">
                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                &times;
                            </button>
                            <h4 class="modal-title">Check Out</h4>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to check out for today?</p>
                        </div>
                        <div class="modal-footer">
                            <input type="hidden" name="_csrf" value="<%=csrfToken%>" />
                            <button type="reset" class="btn btn-default" data-dismiss="modal">
                                No
                            </button>
                            <button type="submit" class="btn btn-primary">Yes, Check Out</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.js" charset="UTF-8"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js" charset="UTF-8"></script>
        <script src="/javascripts/sidebar_menu.js"></script>
        <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.print.min.js"></script>
        
        <style>
            /* Custom styles for attendance page */
            .attendance-row td {
                vertical-align: middle;
                padding: 12px 8px;
            }
            
            .status-badge {
                display: inline-block;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: normal;
                font-size: 13px;
                min-width: 80px;
                text-align: center;
            }
            
            .status-present {
                background-color: #e8f5e9;
                color: #28a745;
                border: 1px solid #28a745;
            }
            
            .status-leave {
                background-color: #fce4ec;
                color: #e542b7;
                border: 1px solid #e542b7;
            }
            
            .status-late {
                background-color: #fff3e0;
                color: #fd7e14;
                border: 1px solid #fd7e14;
            }
            
            .status-unknown {
                background-color: #e0e0e0;
                color: #616161;
                border: 1px solid #9e9e9e;
            }
            
            .btn-edit {
                background-color: #fff;
                color: #dc3545;
                border: 1px solid #dc3545;
                border-radius: 20px;
                padding: 5px 15px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .btn-edit:hover {
                background-color: #dc3545;
                color: #fff;
            }
            
            #attendanceTable th {
                font-weight: bold;
                color: #333;
            }
            
            .dropdown-menu {
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .table-hover tbody tr:hover {
                background-color: #f8f9fa;
            }
            
            /* Make DataTables pagination look better */
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                border-radius: 20px;
                margin: 0 3px;
            }
            
            .dataTables_wrapper .dataTables_paginate .paginate_button.current {
                background: #222;
                color: white !important;
                border: none;
            }
            
            .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
                background: #444;
                color: white !important;
                border: none;
            }
            
            .dataTables_wrapper .dataTables_filter input {
                border-radius: 20px;
                padding: 5px 10px;
                border: 1px solid #ddd;
            }
        </style>
        
        <script>
            $(document).ready(function () {
                // Initialize DataTable with export buttons
                var table = $('#attendanceTable').DataTable({
                    "ordering": false,
                    "paging": true, 
                    "info": false,
                    "searching": true,
                    "pageLength": 10,
                    "lengthChange": false,
                    "dom": 'Bfrtip',
                    "buttons": []
                });
                
                // Populate year dropdown
                var currentYear = new Date().getFullYear();
                var yearSelect = document.getElementById('year');
                var selectedYear = parseInt('<%= year %>');
                
                for (var i = currentYear; i >= currentYear - 5; i--) {
                    var option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === selectedYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
                
                // Export functionality
                $('#exportPDF').click(function(e) {
                    e.preventDefault();
                    table.button('.buttons-pdf').trigger();
                });
                
                $('#exportExcel').click(function(e) {
                    e.preventDefault();
                    table.button('.buttons-excel').trigger();
                });
                
                $('#printBtn').click(function(e) {
                    e.preventDefault();
                    table.button('.buttons-print').trigger();
                });
                
                // Update DataTables buttons after initialization
                new $.fn.dataTable.Buttons(table, {
                    buttons: [
                        {
                            extend: 'pdfHtml5',
                            text: 'Export to PDF',
                            title: 'Attendance Report - ' + '<%= ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][month-1] %>' + ' <%= year %>',
                            className: 'buttons-pdf',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4]
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Export to Excel',
                            title: 'Attendance Report - ' + '<%= ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][month-1] %>' + ' <%= year %>',
                            className: 'buttons-excel',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4]
                            }
                        },
                        {
                            extend: 'print',
                            text: 'Print',
                            title: 'Attendance Report - ' + '<%= ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][month-1] %>' + ' <%= year %>',
                            className: 'buttons-print',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4]
                            }
                        }
                    ]
                });
                
                // Sort functionality
                $('.sort-option').click(function(e) {
                    e.preventDefault();
                    var sortBy = $(this).data('sort');
                    var columnIndex = 0;
                    
                    switch(sortBy) {
                        case 'name':
                            columnIndex = 1;
                            break;
                        case 'checkin':
                            columnIndex = 2;
                            break;
                        case 'status':
                            columnIndex = 4;
                            break;
                        default:
                            columnIndex = 0;
                    }
                    
                    table.order([columnIndex, 'asc']).draw();
                });
                
                // Variable to track if we're adding or editing
                var isAddingNew = false;
                var currentDate = new Date();
                
                // Edit attendance functionality
                $('.edit-attendance').click(function() {
                    var attendanceId = $(this).data('id');
                    var buttonText = $(this).text().trim();
                    
                    // Reset form
                    $('#editAttendanceForm')[0].reset();
                    
                    // Set default values for new records
                    if (buttonText === 'Add') {
                        isAddingNew = true;
                        $('.modal-title').text('Add Attendance Record');
                        
                        // Set today's date for new record
                        var today = new Date();
                        var month = '<%= month %>';
                        var year = '<%= year %>';
                        var day = today.getDate(); // Default to today
                        
                        // Create a datepicker if needed
                        if (!$('#attendanceDate').length) {
                            $('<div class="form-group"><label for="attendanceDate">Date</label><input type="date" class="form-control" id="attendanceDate" name="attendanceDate"></div>').insertBefore($('#statusSelect').parent());
                        }
                        
                        // Set current date value
                        var dateStr = year + '-' + 
                                     (month < 10 ? '0' + month : month) + '-' + 
                                     (day < 10 ? '0' + day : day);
                        $('#attendanceDate').val(dateStr);
                        
                        // Set default times
                        $('#checkInTime').val('09:00');
                        $('#checkOutTime').val('17:00');
                        $('#statusSelect').val('present');
                    } else {
                        isAddingNew = false;
                        $('.modal-title').text('Edit Attendance Record');
                        
                        // Remove date field if it exists
                        if ($('#attendanceDate').length) {
                            $('#attendanceDate').parent().remove();
                        }
                        
                        // Try to load existing data
                        $.ajax({
                            url: '/admin/get-attendance',
                            type: 'GET',
                            data: { id: attendanceId },
                            success: function(data) {
                                if (data.success) {
                                    $('#checkInTime').val(data.record.checkInTime ? data.record.checkInTime.substr(0, 5) : '');
                                    $('#checkOutTime').val(data.record.checkOutTime ? data.record.checkOutTime.substr(0, 5) : '');
                                    $('#statusSelect').val(data.record.status || 'present');
                                }
                            },
                            error: function() {
                                // If error, just continue with empty form
                                console.log('Could not load attendance data');
                            }
                        });
                    }
                    
                    $('#attendanceId').val(attendanceId);
                    $('#editAttendanceModal').modal('show');
                });
                
                $('#saveAttendanceChanges').click(function() {
                    // Get form data
                    var formData = {
                        attendanceId: $('#attendanceId').val(),
                        status: $('#statusSelect').val(),
                        checkInTime: $('#checkInTime').val(),
                        checkOutTime: $('#checkOutTime').val(),
                        _csrf: '<%= csrfToken %>'
                    };
                    
                    // Add date if adding new record
                    if (isAddingNew && $('#attendanceDate').length) {
                        formData.date = $('#attendanceDate').val();
                        formData.isNewRecord = true;
                    }
                    
                    // Send AJAX request to update attendance
                    $.ajax({
                        url: '/admin/edit-attendance',
                        type: 'POST',
                        data: formData,
                        success: function(response) {
                            if (response.success) {
                                alert('Attendance ' + (isAddingNew ? 'added' : 'updated') + ' successfully!');
                                $('#editAttendanceModal').modal('hide');
                                // Reload page to see changes
                                location.reload();
                            } else {
                                alert('Error: ' + response.message);
                            }
                        },
                        error: function(xhr) {
                            alert('Error ' + (isAddingNew ? 'adding' : 'updating') + ' attendance. Please try again.');
                        }
                    });
                });
            });
        </script>
    </body>
</html>