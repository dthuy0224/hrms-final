<!DOCTYPE html>
<html>
<%- include('../partials/header') %>

<body>
  <nav class="navbar navbar-default no-margin">
    <!-- Brand and toggle get grouped for better mobile display -->

    <div class="navbar-header fixed-brand">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" id="menu-toggle">
            <span class="glyphicon glyphicon-th-large" style="margin-left:5px;" aria-hidden="true"></span>
        </button>
        <a class="navbar-brand" href="#"> <%= userName %></a>
    </div><!-- navbar-header-->

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <button class="navbar-toggle collapse in" data-toggle="collapse" id="menu-toggle-2"><span
                            class="glyphicon glyphicon-th-large" aria-hidden="true"></span></button>
            </li>
            <li class="navbar-brand">
                <form action="/logout" method="get">
                    <button id="logout" type="submit" style="margin-top: -3px;" class="btn btn-default"><i
                                class="fa fa-sign-out" aria-hidden="true"></i> Logout
                    </button>
                </form>
            </li>
        </ul>
    </div><!-- bs-example-navbar-collapse-1 -->
</nav>
<div id="wrapper">
    <!-- Sidebar -->
    <%- include('../partials/adminSidebar') %>

    <!-- /#sidebar-wrapper -->
    <!-- Page Content -->
    <div id="page-content-wrapper">
      <div class="container-fluid xyz">
        <div class="row">
          <div class="col-lg-12">
            <h2 class="EmployeeDetails"><i class="fa fa-angle-right"></i> Employee Details</h2>
          </div>
          <style>
              .EmployeeDetails {
                  font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;
                  font-size: 1.6em;
                  padding-bottom: 9px;
                  margin: 12px 0 20px;
                  border-bottom: 1px solid #eee;
                  font-weight: bold;
                  color: #333;
                }
                </style>
        
                
                       <!-- Page Content -->
                       <div id="page-content-wrapper">
                         <div class="container-fluid xyz">
                             <div class="row">
                                 <div class="col-lg-12">
                                    
                                        
                                     <div class="profile-container">
                                         <div class="row">
                                             <!-- Left side profile card -->
                                             <div class="col-md-4">
                                                 <div class="profile-card">
                                                     <div class="profile-header" style="background-color: #222;">
                                                         <div class="employment-badge">
                                                             <% if (employee.employeeType) { %>
                                                                 <%= employee.employeeType %>
                                                             <% } else if (employee.employmentType) { %>
                                                                 <%= employee.employmentType === 'full-time' ? 'Full-Time' : 'Part-Time' %>
                                                             <% } else { %>
                                                                 Full-time
                                                             <% } %>
                                                         </div>
                                                     </div>
                                                     <div class="profile-body text-center">
                                                         <div class="profile-image">
                                                             <% if(employee.photo) { %>
                                                                 <img src="/uploads/<%= employee.photo %>" alt="<%= employee.name %>" class="img-circle">
                                                             <% } else { %>
                                                                 <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Default Avatar" class="img-circle">
                                                             <% } %>
                                                         </div>
                                                         <h3 class="profile-name"><%= employee.name %></h3>
                                                         <p class="profile-id">@<%= employee.jobId || (employee._id.toString().substr(-2)) %></p>
                                                         
                                                         <hr>
                                                         
                                                         <div class="profile-details">
                                                             <p>
                                                                 <i class="fa fa-briefcase"></i> 
                                                                 <%= employee.designation || "UI Designer" %>
                                                             </p>
                                                             <p>
                                                                 <i class="fa fa-building"></i> 
                                                                 Working at: <%= employee.department || 'IT Department' %>
                                                             </p>
                                                             <p>
                                                                 <i class="fa fa-envelope"></i> 
                                                                 <%= employee.personalEmail || employee.email %>
                                                             </p>
                                                             <p>
                                                                 <i class="fa fa-phone"></i> 
                                                               <%= employee.contactNumber || "933387264" %>
                                                             </p>
                                                             <% if (employee.supervisor) { %>
                                                             <p>
                                                                 <i class="fa fa-user"></i> 
                                                                 Report by: <%= employee.supervisor %>
                                                             </p>
                                                             <% } %>
                                                             <p>
                                                                 <i class="fa fa-calendar"></i> 
                                                                 Birthday on: <%= moment(employee.dateOfBirth).format('DD MMMM') %>
                                                             </p>
                                                         </div>
                                                     </div>
                                                 </div>
                                             </div>
                                             
                                             <!-- Right side information panels -->
                                             <div class="col-md-8">
                                                 <div class="row mb-4">
                                                     <div class="col-md-6">
                                                         <div class="info-box">
                                                             <div class="info-box-icon">
                                                                 <i class="fa fa-calendar-check-o"></i>
                                                             </div>
                                                             <div class="info-box-content">
                                                                 <h4>Start Date</h4>
                                                                 <p><%= employee.startDate ? moment(employee.startDate).format('DD MMMM YYYY') : '20 April 2021' %></p>
                                                             </div>
                                                         </div>
                                                     </div>
                                                     <div class="col-md-6">
                                                         <div class="info-box">
                                                             <div class="info-box-icon">
                                                                 <i class="fa fa-birthday-cake"></i>
                                                             </div>
                                                             <div class="info-box-content">
                                                                 <h4>Date of Birth</h4>
                                                                 <p><%= moment(employee.dateOfBirth).format('DD MMMM YYYY') %></p>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 
                                                 <!-- Personal Information Panel -->
                                                 <div class="panel panel-info">
                                                     <div class="panel-heading">
                                                         <h3 class="panel-title">Personal information</h3>
                                                         <button type="button" class="btn btn-default btn-xs btn-edit" data-toggle="modal" data-target="#editProfileModal">
                                                             <i class="fa fa-pencil"></i> Edit
                                                         </button>
                                                     </div>
                                                     <div class="panel-body">
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Name:</strong></div>
                                                             <div class="col-md-9"><%= employee.name %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Gender:</strong></div>
                                                             <div class="col-md-9">
                                                                 <%= employee.gender ? (employee.gender.charAt(0).toUpperCase() + employee.gender.slice(1)) : 'Female' %>
                                                             </div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Birthname:</strong></div>
                                                             <div class="col-md-9"><%= employee.birthName %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Birthplace:</strong></div>
                                                             <div class="col-md-9"><%= employee.birthplace || 'Hanoi' %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Address:</strong></div>
                                                             <div class="col-md-9">
                                                                 <% if (employee.detailedAddress || employee.district || employee.province) { %>
                                                                     <%= [employee.detailedAddress, employee.district, employee.province].filter(Boolean).join(', ') %>
                                                                 <% } else { %>
                                                                     Nguyen Trai St, Trung Van Ward, Nam Tu Liem District, Hanoi
                                                                 <% } %>
                                                             </div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>ID Number:</strong></div>
                                                             <div class="col-md-9"><%= employee.idNumber || '035304001786' %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Personal Email:</strong></div>
                                                             <div class="col-md-9"><%= employee.personalEmail || (employee.email.replace('@hrms.com', '@gmail.com')) %></div>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 
                                                 <!-- Job Information Panel -->
                                                 <div class="panel panel-info">
                                                     <div class="panel-heading">
                                                         <h3 class="panel-title">Job information</h3>
                                                     </div>
                                                     <div class="panel-body">
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Job ID:</strong></div>
                                                             <div class="col-md-9"><%= employee.jobId || 'Not assigned' %></div>
                                                         </div>
                                                        
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Job Title:</strong></div>
                                                             <div class="col-md-9"><%= employee.designation || 'Admin' %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Official Email:</strong></div>
                                                             <div class="col-md-9"><%= employee.officeEmail || employee.officeEmail %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Employment Type:</strong></div>
                                                             <div class="col-md-9">
                                                                 <% if (employee.employeeType) { %>
                                                                     <%= employee.employeeType %>
                                                                 <% } else if (employee.employmentType) { %>
                                                                     <%= employee.employmentType === 'full-time' ? 'Full-Time' : 'Part-Time' %>
                                                                 <% } else { %>
                                                                     Full-Time
                                                                 <% } %>
                                                             </div>
                                                         </div>
                                                         <% if (employee.supervisor) { %>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Supervisor:</strong></div>
                                                             <div class="col-md-9"><%= employee.supervisor %></div>
                                                         </div>
                                                         <% } %>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Department:</strong></div>
                                                             <div class="col-md-9"><%= employee.department || 'HR & Administration' %></div>
                                                         </div>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Work Experience:</strong></div>
                                                             <div class="col-md-9"><%= employee.experience || 'Senior' %></div>
                                                         </div>
                                                         <% if (employee.Skills && employee.Skills.length > 0) { %>
                                                         <div class="row mb-3">
                                                             <div class="col-md-3"><strong>Skills:</strong></div>
                                                             <div class="col-md-9">
                                                                 <% employee.Skills.forEach(function(skill, index) { %>
                                                                     <% if (skill !== "") { %>
                                                                         <span class="badge badge-info"><%= skill %></span>
                                                                     <% } %>
                                                                 <% }); %>
                                                             </div>
                                                         </div>
                                                         <% } %>
                                                     </div>
                                                 </div>
                                             </div>
                                         </div>
                                           <!-- Action Buttons -->
                                         
                <div class="row text-right" style="margin-bottom: 15px; margin-top: 10px;">
                  <div class="col-md-12">
                    <a href="/admin/view-all-employees" class="btn btn-default">
                     Back
                    </a>
                   
                  </div>
                </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <!-- /#page-content-wrapper -->
                 </div>
                 <!-- /#wrapper -->
                 <!-- jQuery -->
                 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.js" charset="UTF-8"></script>
                 <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js" charset="UTF-8"></script>
                 <script src="/javascripts/sidebar_menu.js"></script>
                 
                 <!-- CSS for profile page -->
                 <style>
                     /* Styles for profile page */
                     .profile-container {
                         margin-top: 20px;
                     }
                     .profile-card {
                         border: 1px solid #ddd;
                         border-radius: 5px;
                         overflow: hidden;
                         margin-bottom: 20px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                     }
                     .profile-header {
                         height: 50px;
                         position: relative;
                     }
                  
                     .employment-badge {
                         position: absolute;
                         top: 10px;
                         right: 10px;
                         background-color: rgba(255,255,255,0.8);
                         color: #333;
                         padding: 5px 10px;
                         border-radius: 3px;
                         font-size: 12px;
                         font-weight: bold;
                     }
                     .profile-body {
                         padding: 20px;
                         background-color: #f9f9f9;
                     }
                     .profile-image {
                         position: relative;
                         z-index: 2;
                         text-align: center;
                         margin-bottom: 15px;
                     }
                     .profile-image img {
                         width: 120px;
                         height: 120px;
                         border: 5px solid white;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                         margin-top: -60px;
                         display: inline-block;
                     }
                     .profile-name {
                         font-size: 24px;
                         margin-bottom: 5px;
                     }
                     .profile-id {
                         color: #666;
                         margin-bottom: 15px;
                     }
                     .profile-details {
                         text-align: left;
                     }
                     .profile-details p {
                         margin-bottom: 10px;
                     }
                     .profile-details i {
                         margin-right: 10px;
                         width: 16px;
                         color: #3498db;
                     }
                     .info-box {
                         display: flex;
                         background-color: #e8f4fc;
                         border-radius: 5px;
                         padding: 15px;
                         margin-bottom: 20px;
                         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                     }
                     .info-box-icon {
                         font-size: 24px;
                         margin-right: 15px;
                         color: #3498db;
                     }
                     .info-box-content h4 {
                         margin-top: 0;
                         margin-bottom: 5px;
                         font-size: 16px;
                         color: #555;
                     }
                     .info-box-content p {
                         margin: 0;
                         font-size: 16px;
                         font-weight: bold;
                     }
                     .panel-info > .panel-heading {
                         display: flex;
                         justify-content: space-between;
                         align-items: center;
                         background-color: #d9edf7;
                         color: #31708f;
                     }
                     .panel-title {
                         margin: 0;
                     }
                     .btn-edit {
                         padding: 2px 8px;
                     }
                     .row.mb-3 {
                         margin-bottom: 15px;
                     }
                     .badge-info {
                         background-color: #3498db;
                         margin-right: 5px;
                         padding: 5px 10px;
                         border-radius: 3px;
                         color: white;
                         display: inline-block;
                     }
                     .page-header {
                         margin-bottom: 20px;
                     }
                     .breadcrumb {
                         background-color: #f8f8f8;
                         padding: 8px 15px;
                         margin-bottom: 10px;
                         border-radius: 4px;
                     }
                 </style>
             </body>
             <script>
                 $(document).ready(function () {
                    // Any additional script can go here
           
                    var originalValues = {
                        birthName: '',
                        personalEmail: '',
                        contactNumber: '',
                        photoFileName: ''
                    };
           
                    var $saveButton = $('#editProfileModal').find('button.btn-primary.btn-custom[type="submit"]');
           
                    // Disable Save button initially when modal opens
                    $('#editProfileModal').on('show.bs.modal', function () {
                        // Store original values
                        originalValues.birthName = $('#editbirthName').val() || '';
                        originalValues.personalEmail = $('#editEmail').val() || '';
                        originalValues.contactNumber = $('#editContactNumber').val() || '';
                        originalValues.photoFileName = $('#file-name-display').text().trim() || '';
           
                        // Disable Save button initially
                        $saveButton.prop('disabled', true);
                    });
           
                    // Function to check if any field has changed
                    function checkForChanges() {
                        var currentBirthName = $('#editbirthName').val() || '';
                        var currentPersonalEmail = $('#editEmail').val() || '';
                        var currentContactNumber = $('#editContactNumber').val() || '';
                        var currentPhotoFileName = $('#file-name-display').text().trim() || '';
           
                        if (
                            currentBirthName !== originalValues.birthName ||
                            currentPersonalEmail !== originalValues.personalEmail ||
                            currentContactNumber !== originalValues.contactNumber ||
                            currentPhotoFileName !== originalValues.photoFileName
                        ) {
                            $saveButton.prop('disabled', false);
                        } else {
                            $saveButton.prop('disabled', true);
                        }
                    }
           
                    // Attach event listeners to inputs
                    $('#editbirthName, #editEmail, #editContactNumber').on('input', function () {
                        checkForChanges();
                    });
           
                    // Listen for photo file input change
                    $('#photo').on('change', function () {
                        // The file name display is updated by existing code, so just check changes
                        checkForChanges();
                    });
                 });
             </script>
             <div id="myModal2" class="modal fade" role="dialog">
                 <div class="modal-dialog">
                     <form method="post" action="/employee/mark-employee-attendance">
                         <!-- Modal content-->
                         <div class="modal-content">
                             <div class="modal-header">
                                 <button type="button" class="close" data-dismiss="modal">
                                     &times;
                                 </button>
                                 <h4 class="modal-title">Mark Attendance</h4>
                             </div>
                             <div class="modal-body">
                                 <p>Are you sure you want to mark attendance.</p>
                             </div>
                             <div class="modal-footer">
                                 <button type="reset" class="btn btn-default" data-dismiss="modal">
                                     No
                                 </button>
                                 <button type="submit" class="btn btn-default">Yes</button>
                             </div>
                         </div>
                     </form>
                 </div>
             </div>
             <div id="myModal" class="modal fade" role="dialog">
                 <div class="modal-dialog">
                     <!-- Modal content-->
                     <div class="modal-content">
                         <form method="post" action="/employee/view-attendance">
                             <div class="modal-header">
                                 <button type="button" class="close" data-dismiss="modal">
                                     &times;
                                 </button>
                                 <h4 class="modal-title">Select Month/Year</h4>
                             </div>
                             <div class="modal-body">
                                 <div class="form-group">
                                     <label for="Month">Month:</label>
                                     <select class="form-control" id="month" name="month">
                                         <option value="1">January</option>
                                         <option value="2">February</option>
                                         <option value="3">March</option>
                                         <option value="4">April</option>
                                         <option value="5">May</option>
                                         <option value="6">June</option>
                                         <option value="7">July</option>
                                         <option value="8">August</option>
                                         <option value="9">September</option>
                                         <option value="10">October</option>
                                         <option value="11">November</option>
                                         <option value="12">December</option>
                                     </select>
                                 </div>
                                 <div class="form-group">
                                     <label for="year">Year:</label>
                                     <select class="form-control" id="year" name="year"></select>
                                 </div>
                             </div>
                             <div class="modal-footer">
                                 <button type="reset" class="btn btn-default" data-dismiss="modal">
                                     Close
                                 </button>
                                 <button type="submit" class="btn btn-default">View</button>
                             </div>
                         </form>
                     </div>
                 </div>
             </div>
           
           
           <style>
           /* Tổng thể panel */
           .profile-panel {
             padding: 10px;
             border: 1px solid #ddd;
             border-radius: 8px;
             max-width: 900px;
             margin: 0 auto;
             color:#333;
           }
           
           
           /* Tiêu đề bên trái */
           .profile-title {
             font-size: 20px;
             font-weight: bold;
             margin: 0;
           }
           
           /* Nhóm nút bên phải */
           .profile-buttons {
             display: flex;
             gap: 12px;
           }
           
           /* Tùy chỉnh nút */
           .btn-custom {
             min-width: 75px;
             height: 38px;
             font-size: 14px;
             border-radius: 6px;
             padding: 8px 20px;
             white-space: nowrap;
             border-color: #c5bebe;
           }
           .profile-header {
                         height: 50px;
                         position: relative;
                      
                     }
                     /* Header chứa title và button - dùng flex chia trái/phải */
           .profile-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: nowrap; /* Không cho xuống dòng */
           }
              
           .profile-header {
                       
                       height: 50px;
                       position: relative;
                   }
           </style>
                         
                         </form>
                     </div>
                 </div>
             </div>
           </div>
           </html>
           <script>
             $(document).ready(function () {
                // Hiển thị thông báo flash message
                <% if (messages && messages.success) { %>
                     showAlert('<%= messages.success %>', 'success');
                 <% } else if (messages && messages.error) { %>
                     showAlert('<%= messages.error %>', 'danger');
                 <% } %>
                 
                 // Hàm hiển thị thông báo
                 function showAlert(message, type) {
                     var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">';
                     alertHtml += '<button type="button" class="close" data-dismiss="alert" aria-label="Close">';
                     alertHtml += '<span aria-hidden="true">&times;</span></button>';
                     alertHtml += message + '</div>';
                     $('.page-header').after(alertHtml);
                     
                     // Tự động ẩn sau 5 giây
                     setTimeout(function() {
                         $('.alert').fadeOut('slow', function() {
                             $(this).remove();
                         });
                     }, 5000);
                 }
                 
                 // Khởi tạo giá trị cho form khi mở modal
                 $('#editProfileModal').on('show.bs.modal', function () {
                     // Thiết lập các giá trị cơ bản
                     setFormValue('editName', '<%= employee.name || "" %>');
                     setFormValue('editEmail', '<%= employee.email || "" %>');
                     setFormValue('editGender', '<%= employee.gender || "" %>');
                     setFormValue('editbirthName', '<%= employee.birthName || "" %>');
           
                     setFormValue('editDesignation', '<%= employee.designation || "" %>');
                    
                     setFormValue('editSupervisor', '<%= employee.supervisor || "" %>');
                     setFormValue('editDateOfBirth', '<%= employee.dateOfBirth ? moment(employee.dateOfBirth).format("YYYY-MM-DD") : "" %>');
                     setFormValue('editBirthplace', '<%= employee.birthplace || "" %>');
                     setFormValue('editProvince', '<%= employee.province || "" %>');
                     setFormValue('editDistrict', '<%= employee.district || "" %>');
                     setFormValue('editDetailedAddress', '<%= employee.detailedAddress || "" %>');
                     setFormValue('editIdNumber', '<%= employee.idNumber || "" %>');
                     setFormValue('editPersonalEmail', '<%= employee.officeEmail || "" %>');
                     setFormValue('editJobId', '<%= employee.jobId || "" %>');
                     setFormValue('editContactNumber', '<%= employee.contactNumber || "" %>');
                     setFormValue('editDepartment', '<%= employee.department || "HR & Administration" %>');
                     setFormValue('editExperience', '<%= employee.experience || "Senior" %>');
                     setFormValue('editSupervisor', '<%= employee.supervisor || "" %>');
                     setFormValue('editSkills', '<%= employee.Skills ? employee.Skills.join(", ") : "" %>');
                        // Set department value if it exists
                        var deptValue = '<%= employee.department || "HR & Administration" %>';
                     if (deptValue) {
                         $('#editDepartment').val(deptValue);
                     } else {
                         $('#editDepartment').val('HR & Administration');
                     }
           
                     <% if (employee.startDate) { %>
                     setFormValue('editStartDate', '<%= moment(employee.startDate).format("YYYY-MM-DD") %>');
                     <% } %>
                     
                     // Thiết lập giá trị loại hình làm việc
                     <% if (employee.employeeType) { %>
                     setFormValue('editEmployeeType', '<%= employee.employeeType %>');
                     <% } else if (employee.employmentType) { %>
                     setFormValue('editEmployeeType', '<%= employee.employmentType === "full-time" ? "Full-Time" : "Part-Time" %>');
                     <% } %>
                     
                     // Tải dữ liệu tỉnh
                     loadProvincesData();
                 });
                 
                 // Hàm trợ giúp thiết lập giá trị form
                 function setFormValue(id, value) {
                     $('#' + id).val(value);
                 }
                 
                 // Tối ưu hóa hàm tải dữ liệu tỉnh
                 function loadProvincesData() {
                     // Cache kết quả trong biến cục bộ
                     if (window.provincesData) {
                         populateProvinces(window.provincesData);
                         return;
                     }
                     
                     $.ajax({
                         url: 'https://provinces.open-api.vn/api/?depth=2',
                         type: 'GET',
                         dataType: 'json',
                         success: function(data) {
                             // Lưu cache
                             window.provincesData = data;
                             populateProvinces(data);
                         },
                         error: function(xhr, status, error) {
                             console.error('Error loading provinces data:', error);
                         }
                     });
                 }
                 
                 // Tách logic hiển thị tỉnh thành
                 function populateProvinces(data) {
                     // Sắp xếp tỉnh theo tên
                     data.sort(function(a, b) {
                         return a.name.localeCompare(b.name);
                     });
                     
                     // Cập nhật dropdown tỉnh
                     var $provinceSelect = $('#editProvince');
                     $provinceSelect.empty();
                     $provinceSelect.append('<option value="">Chọn tỉnh/thành</option>');
                     
                     $.each(data, function(i, province) {
                         $provinceSelect.append('<option value="' + province.name + '" data-code="' + province.code + '">' + province.name + '</option>');
                     });
                     
                     // Thiết lập tỉnh đã chọn
                     var currentProvince = '<%= employee.province || "" %>';
                     if (currentProvince) {
                         $provinceSelect.val(currentProvince);
                         // Kích hoạt sự kiện change để tải quận/huyện
                         $provinceSelect.trigger('change');
                     }
                     
                     // Xử lý khi thay đổi tỉnh
                     $provinceSelect.off('change').on('change', function() {
                         var provinceCode = $('option:selected', this).attr('data-code');
                         updateDistricts(provinceCode, data);
                     });
                 }
                 
                 // Không thay đổi hàm này
                 function updateDistricts(provinceCode, provincesData) {
                     var $districtSelect = $('#editDistrict');
                     $districtSelect.empty();
                     $districtSelect.append('<option value="">Chọn quận/huyện</option>');
                     
                     if (!provinceCode) {
                         return;
                     }
                     
                     // Tìm tỉnh đã chọn
                     var selectedProvince = provincesData.find(function(province) {
                         return province.code == provinceCode;
                     });
                     
                     if (selectedProvince && selectedProvince.districts) {
                         // Sắp xếp quận/huyện theo tên
                         selectedProvince.districts.sort(function(a, b) {
                             return a.name.localeCompare(b.name);
                         });
                         
                         // Thêm quận/huyện vào dropdown
                         $.each(selectedProvince.districts, function(i, district) {
                             $districtSelect.append('<option value="' + district.name + '">' + district.name + '</option>');
                         });
                         
                         // Thiết lập quận/huyện đã chọn
                         var currentDistrict = '<%= employee.district || "" %>';
                         if (currentDistrict) {
                             $districtSelect.val(currentDistrict);
                         }
                     }
                 }
             });
           </script>
                 <!-- Thêm CSS cho trang profile -->
                 <style>
                     /* Styles for profile page */
                     .profile-container {
                         margin-top: 20px;
                     }
                     .profile-card {
                         border: 1px solid #ddd;
                         border-radius: 5px;
                         overflow: hidden;
                         margin-bottom: 20px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                     }
                     
                     .employment-badge {
                         position: absolute;
                         top: 10px;
                         right: 10px;
                         background-color: rgba(255,255,255,0.8);
                         color: #333;
                         padding: 5px 10px;
                         border-radius: 3px;
                         font-size: 12px;
                         font-weight: bold;
                     }
                     .profile-body {
                         padding: 20px;
                         background-color: #f9f9f9;
                     }
                     .profile-image {
                         position: relative;
                         z-index: 2;
                         text-align: center;
                         margin-bottom: 15px;
                     }
                     .profile-image img {
                         width: 120px;
                         height: 120px;
                         border: 5px solid white;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                         margin-top: -60px;
                         display: inline-block;
                     }
                     .profile-name {
                         font-size: 24px;
                         margin-bottom: 5px;
                     }
                     .profile-id {
                         color: #666;
                         margin-bottom: 15px;
                     }
                     .profile-details {
                         text-align: left;
                     }
                     .profile-details p {
                         margin-bottom: 10px;
                     }
                     .profile-details i {
                         margin-right: 10px;
                         width: 16px;
                         color: #3498db;
                     }
                     .info-box {
                         display: flex;
                         background-color: #e8f4fc;
                         border-radius: 5px;
                         padding: 15px;
                         margin-bottom: 20px;
                         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                     }
                     .info-box-icon {
                         font-size: 24px;
                         margin-right: 15px;
                         color: #3498db;
                     }
                     .info-box-content h4 {
                         margin-top: 0;
                         margin-bottom: 5px;
                         font-size: 16px;
                         color: #555;
                     }
                     .info-box-content p {
                         margin: 0;
                         font-size: 16px;
                         font-weight: bold;
                     }
                     .panel-info > .panel-heading {
                         display: flex;
                         justify-content: space-between;
                         align-items: center;
                         background-color: #d9edf7;
                         color: #31708f;
                     }
                     .panel-title {
                         margin: 0;
                     }
                     .btn-edit {
                         padding: 2px 8px;
                     }
                     .row.mb-3 {
                         margin-bottom: 15px;
                     }
                     .badge-info {
                         background-color: #3498db;
                         margin-right: 5px;
                         padding: 5px 10px;
                         border-radius: 3px;
                     }
                 </style>
             </body>
             <style>
                 .file-input {
                    display: none;
                }
                .thumbnail {
                    border: 1px solid #ddd;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background-color: #f5f5f5;
                }
                .breadcrumb {
                    background-color: transparent;
                    padding-left: 0;
                }
                .panel-title {
                    font-weight: bold;
                }
                .form-group {
                    margin-bottom: 15px;
                }
                .panel {
                    margin-bottom: 20px;
                }
                .help-block {
                    margin-top: 5px;
                    margin-bottom: 0;
                }
                .text-danger {
                    color: #a94442;
                }
                .api-error {
                    color: #a94442;
                    background-color: #f2dede;
                    border-color: #ebccd1;
                }
                .error-input {
                    border-color: #a94442;
                    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
                    box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
                    background-color: #fff8f8;
                }
                .error-message {
                    color: #a94442;
                    margin-top: 5px;
                    display: none;
                    font-size: 12px;
                    font-weight: bold;
                    animation: fadeIn 0.3s;
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                .required-field {
                    color: #a94442;
                    margin-left: 3px;
                }
                /* Add style for form legend */
                .form-legend {
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid #eee;
                }
                .form-legend .text-danger {
                    font-size: 14px;
                    font-weight: normal;
                    margin-left: 10px;
                }
                /* Custom file upload styles */
                .custom-file-upload {
                    display: inline-block;
                    margin-bottom: 10px;
                }
                #file-name-display {
                    display: inline-block;
                    vertical-align: middle;
                    color: #555;
                    font-style: italic;
                }
                /* Checkbox scroll container styles */
                .checkbox-scroll-container {
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    background-color: #fff;
                }
                .checkbox-scroll {
                    max-height: 150px;
                    overflow-y: auto;
                    padding: 10px;
                }
                .checkbox-scroll .checkbox {
                    margin-top: 2px;
                    margin-bottom: 2px;
                }
                .checkbox-scroll .checkbox label {
                    font-weight: normal;
                }
                </style>
                
           <!-- CSRF Token Refresh Script -->
           <script>
             // CSRF Token Refresh
             $(document).ready(function() {
                 $.ajaxSetup({
                     headers: {
                         'X-CSRF-Token': '<%= csrfToken %>'
                     }
                 });
                 
                 // Đặt token vào form chính
                 var csrfToken = '<%= csrfToken %>';
                 $('input[name="_csrf"]').val(csrfToken);
                 
                 // Kiểm tra và làm mới token mỗi 10 phút
                 setInterval(function() {
                     $.get('/refresh-csrf', function(data) {
                         $('input[name="_csrf"]').val(data.csrfToken);
                     });
                 }, 10 * 60 * 1000); // 10 phút
                 
           $(document).ready(function() {
             // Image preview
             $("#photo").change(function() {
                 if (this.files && this.files[0]) {
                     var reader = new FileReader();
                     reader.onload = function(e) {
                         $('#preview-image').attr('src', e.target.result);
                     }
                     reader.readAsDataURL(this.files[0]);
                     
                     // Hiển thị tên file đã chọn
                     $('#file-name-display').text(this.files[0].name);
                 } else {
                     // Reset về giá trị mặc định nếu không có file nào được chọn
                     $('#preview-image').attr('src', '<%= employee.photo ? "/uploads/" + employee.photo : "https://bootdey.com/img/Content/avatar/avatar7.png" %>');
                     $('#file-name-display').text('<%= employee.photo ? "Current photo" : "No file chosen" %>');
                 }
             });
           
             // Upload button click handler
             $('#upload-button').click(function() {
                 var fileInput = $('#photo')[0];
                 if (fileInput.files.length === 0) {
                     alert('Please select a file to upload.');
                     return;
                 }
                 var formData = new FormData();
                 formData.append('photo', fileInput.files[0]);
           
                 $.ajax({
                     url: '/employee/upload-photo',
                     type: 'POST',
                     data: formData,
                     processData: false,
                     contentType: false,
                     success: function(response) {
                         if (response && response.filePath) {
                             $('#preview-image').attr('src', response.filePath);
                             $('#file-name-display').text(fileInput.files[0].name);
                             alert('Photo uploaded successfully.');
                         } else {
                             alert('Upload failed: Invalid response from server.');
                         }
                     },
                     error: function() {
                         alert('Upload failed: Server error.');
                     }
                 });
             });
           });
                 
                 // Auto-scroll to form validation errors if any
                 if ($('.text-danger').length > 0) {
                     $('html, body').animate({
                         scrollTop: $('.text-danger').first().offset().top - 100
                     }, 200);
                 }
                 
                 // Real-time validation for required fields
                 $('input[required], select[required]').on('blur', function() {
                     if (!this.value.trim()) {
                         $(this).addClass('error-input');
                         $(this).closest('.form-group').find('.error-message').show();
                     } else {
                         $(this).removeClass('error-input');
                         $(this).closest('.form-group').find('.error-message').hide();
                     }
                 });
                 
           
           </script>
             <%- include('../partials/modals') %>
           </html>
           
                
              
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->
  </div>
  <!-- /#wrapper -->
  
  <!-- Delete Employee Modal -->
  <div id="deleteEmployeeModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <form method="post" action="/admin/delete-employee/<%= employee._id %>">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
            <h2 class="modal-title">Delete Employee</h2>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete <%= employee.name %>?</p>
            <p>This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <button type="button" class="btn btn-default" data-dismiss="modal">
              No
            </button>
            <button type="submit" class="btn btn-danger">Yes</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Attendance Modal -->
  <div id="myModal2" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <form method="post" action="/admin/mark-attendance">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
            <h4 class="modal-title">Mark Attendance</h4>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to mark attendance?</p>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
<button type="submit" class="btn btn-primary">Yes</button>            <button type="reset" class="btn btn-default" data-dismiss="modal">
              Cancel
            </button>
            
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.3/jquery.js" charset="UTF-8"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.js" charset="UTF-8"></script>
  <script src="/javascripts/sidebar_menu.js"></script>
  <script>
    $(document).ready(function() {
      // Đảm bảo menu Employees được mở khi load trang
      $("#menu3").click();
    });
  </script>
</body>
</html> 